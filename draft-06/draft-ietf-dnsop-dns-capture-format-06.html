<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>C-DNS: A DNS Packet Capture Format</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
      /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
      a.info {
          /* This is the key. */
          position: relative;
          z-index: 24;
          text-decoration: none;
      }
      a.info:hover {
          z-index: 25;
          color: #FFF; background-color: #900;
      }
      a.info span { display: none; }
      a.info:hover span.info {
          /* The span will display just on :hover state. */
          display: block;
          position: absolute;
          font-size: smaller;
          top: 2em; left: -5em; width: 15em;
          padding: 2px; border: 1px solid #333;
          color: #900; background-color: #EEE;
          text-align: left;
      }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  max-width: 55em;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology"/>
<link href="#rfc.section.3" rel="Chapter" title="3 Data collection use cases"/>
<link href="#rfc.section.4" rel="Chapter" title="4 Design considerations"/>
<link href="#rfc.section.5" rel="Chapter" title="5 Choice of CBOR"/>
<link href="#rfc.section.6" rel="Chapter" title="6 C-DNS format conceptual overview"/>
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Block Parameters"/>
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 Storage Parameters"/>
<link href="#rfc.section.6.2.1" rel="Chapter" title="6.2.1 Optional data items"/>
<link href="#rfc.section.6.2.2" rel="Chapter" title="6.2.2 Optional RRs and OPCODES"/>
<link href="#rfc.section.6.2.3" rel="Chapter" title="6.2.3 Storage flags"/>
<link href="#rfc.section.6.2.4" rel="Chapter" title="6.2.4 IP Address storage"/>
<link href="#rfc.section.7" rel="Chapter" title="7 C-DNS format detailed description"/>
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 Map quantities and indexes"/>
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 Tabular representation"/>
<link href="#rfc.section.7.3" rel="Chapter" title="7.3 &quot;File&quot;"/>
<link href="#rfc.section.7.4" rel="Chapter" title="7.4 &quot;FilePreamble&quot;"/>
<link href="#rfc.section.7.4.1" rel="Chapter" title="7.4.1 &quot;BlockParameters&quot;"/>
<link href="#rfc.section.7.4.2" rel="Chapter" title="7.4.2 &quot;CollectionParameters&quot;"/>
<link href="#rfc.section.7.5" rel="Chapter" title="7.5 &quot;Block&quot;"/>
<link href="#rfc.section.7.5.1" rel="Chapter" title="7.5.1 &quot;BlockPreamble&quot;"/>
<link href="#rfc.section.7.5.2" rel="Chapter" title="7.5.2 &quot;BlockStatistics&quot;"/>
<link href="#rfc.section.7.5.3" rel="Chapter" title="7.5.3 &quot;BlockTables&quot;"/>
<link href="#rfc.section.7.6" rel="Chapter" title="7.6 &quot;QueryResponse&quot;"/>
<link href="#rfc.section.7.6.1" rel="Chapter" title="7.6.1 &quot;ResponseProcessingData&quot;"/>
<link href="#rfc.section.7.6.2" rel="Chapter" title="7.6.2 &quot;QueryResponseExtended&quot;"/>
<link href="#rfc.section.7.7" rel="Chapter" title="7.7 &quot;AddressEventCount&quot;"/>
<link href="#rfc.section.7.8" rel="Chapter" title="7.8 &quot;MalformedMessage&quot;"/>
<link href="#rfc.section.8" rel="Chapter" title="8 Malformed messages"/>
<link href="#rfc.section.9" rel="Chapter" title="9 C-DNS to PCAP"/>
<link href="#rfc.section.9.1" rel="Chapter" title="9.1 Name compression"/>
<link href="#rfc.section.10" rel="Chapter" title="10 Data collection"/>
<link href="#rfc.section.10.1" rel="Chapter" title="10.1 Matching algorithm"/>
<link href="#rfc.section.10.2" rel="Chapter" title="10.2 Message identifiers"/>
<link href="#rfc.section.10.2.1" rel="Chapter" title="10.2.1 Primary ID (required)"/>
<link href="#rfc.section.10.2.2" rel="Chapter" title="10.2.2 Secondary ID (optional)"/>
<link href="#rfc.section.10.3" rel="Chapter" title="10.3 Algorithm parameters"/>
<link href="#rfc.section.10.4" rel="Chapter" title="10.4 Algorithm requirements"/>
<link href="#rfc.section.10.5" rel="Chapter" title="10.5 Algorithm limitations"/>
<link href="#rfc.section.10.6" rel="Chapter" title="10.6 Workspace"/>
<link href="#rfc.section.10.7" rel="Chapter" title="10.7 Output"/>
<link href="#rfc.section.10.8" rel="Chapter" title="10.8 Post processing"/>
<link href="#rfc.section.11" rel="Chapter" title="11 Implementation guidance"/>
<link href="#rfc.section.11.1" rel="Chapter" title="11.1 Optional data"/>
<link href="#rfc.section.11.2" rel="Chapter" title="11.2 Trailing data in TCP"/>
<link href="#rfc.section.11.3" rel="Chapter" title="11.3 Limiting collection of RDATA"/>
<link href="#rfc.section.12" rel="Chapter" title="12 Implementation status"/>
<link href="#rfc.section.12.1" rel="Chapter" title="12.1 DNS-STATS Compactor"/>
<link href="#rfc.section.13" rel="Chapter" title="13 IANA considerations"/>
<link href="#rfc.section.14" rel="Chapter" title="14 Security considerations"/>
<link href="#rfc.section.15" rel="Chapter" title="15 Acknowledgements"/>
<link href="#rfc.section.16" rel="Chapter" title="16 Changelog"/>
<link href="#rfc.references" rel="Chapter" title="17 References"/>
<link href="#rfc.references.1" rel="Chapter" title="17.1 Normative References"/>
<link href="#rfc.references.2" rel="Chapter" title="17.2 Informative References"/>
<link href="#rfc.appendix.A" rel="Chapter" title="A CDDL"/>
<link href="#rfc.appendix.B" rel="Chapter" title="B DNS Name compression example"/>
<link href="#rfc.appendix.B.1" rel="Chapter" title="B.1 NSD compression algorithm"/>
<link href="#rfc.appendix.B.2" rel="Chapter" title="B.2 Knot Authoritative compression algorithm"/>
<link href="#rfc.appendix.B.3" rel="Chapter" title="B.3 Observed differences"/>
<link href="#rfc.appendix.C" rel="Chapter" title="C Comparison of Binary Formats"/>
<link href="#rfc.appendix.C.1" rel="Chapter" title="C.1 Comparison with full PCAP files"/>
<link href="#rfc.appendix.C.2" rel="Chapter" title="C.2 Simple versus block coding"/>
<link href="#rfc.appendix.C.3" rel="Chapter" title="C.3 Binary versus text formats"/>
<link href="#rfc.appendix.C.4" rel="Chapter" title="C.4 Performance"/>
<link href="#rfc.appendix.C.5" rel="Chapter" title="C.5 Conclusions"/>
<link href="#rfc.appendix.C.6" rel="Chapter" title="C.6 Block size choice"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.5.1 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Dickinson, J., Hague, J., Dickinson, S., Manderson, T., and J. Bond" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-ietf-dnsop-dns-capture-format-06" />
  <meta name="dct.issued" scheme="ISO8601" content="2018-2-21" />
  <meta name="dct.abstract" content="This document describes a data representation for collections of DNS messages.  The format is designed for efficient storage and transmission of large packet captures of DNS traffic; it attempts to minimize the size of such packet capture files but retain the full DNS message contents along with the most useful transport metadata.  It is intended to assist with the development of DNS traffic monitoring applications.  " />
  <meta name="description" content="This document describes a data representation for collections of DNS messages.  The format is designed for efficient storage and transmission of large packet captures of DNS traffic; it attempts to minimize the size of such packet capture files but retain the full DNS message contents along with the most useful transport metadata.  It is intended to assist with the development of DNS traffic monitoring applications.  " />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">dnsop</td>
  <td class="right">J. Dickinson</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">J. Hague</td>
</tr>
<tr>
  <td class="left">Intended status: Standards Track</td>
  <td class="right">S. Dickinson</td>
</tr>
<tr>
  <td class="left">Expires: August 25, 2018</td>
  <td class="right">Sinodun IT</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">T. Manderson</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">J. Bond</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">ICANN</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">February 21, 2018</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">C-DNS: A DNS Packet Capture Format<br />
  <span class="filename">draft-ietf-dnsop-dns-capture-format-06</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>This document describes a data representation for collections of DNS messages.  The format is designed for efficient storage and transmission of large packet captures of DNS traffic; it attempts to minimize the size of such packet capture files but retain the full DNS message contents along with the most useful transport metadata.  It is intended to assist with the development of DNS traffic monitoring applications.  </p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on August 25, 2018.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2018 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<li>2.   <a href="#rfc.section.2">Terminology</a></li>
<li>3.   <a href="#rfc.section.3">Data collection use cases</a></li>
<li>4.   <a href="#rfc.section.4">Design considerations</a></li>
<li>5.   <a href="#rfc.section.5">Choice of CBOR</a></li>
<li>6.   <a href="#rfc.section.6">C-DNS format conceptual overview</a></li>
<ul><li>6.1.   <a href="#rfc.section.6.1">Block Parameters</a></li>
<li>6.2.   <a href="#rfc.section.6.2">Storage Parameters</a></li>
<ul><li>6.2.1.   <a href="#rfc.section.6.2.1">Optional data items</a></li>
<li>6.2.2.   <a href="#rfc.section.6.2.2">Optional RRs and OPCODES</a></li>
<li>6.2.3.   <a href="#rfc.section.6.2.3">Storage flags</a></li>
<li>6.2.4.   <a href="#rfc.section.6.2.4">IP Address storage</a></li>
</ul></ul><li>7.   <a href="#rfc.section.7">C-DNS format detailed description</a></li>
<ul><li>7.1.   <a href="#rfc.section.7.1">Map quantities and indexes</a></li>
<li>7.2.   <a href="#rfc.section.7.2">Tabular representation</a></li>
<li>7.3.   <a href="#rfc.section.7.3">"File"</a></li>
<li>7.4.   <a href="#rfc.section.7.4">"FilePreamble"</a></li>
<ul><li>7.4.1.   <a href="#rfc.section.7.4.1">"BlockParameters"</a></li>
<li>7.4.2.   <a href="#rfc.section.7.4.2">"CollectionParameters"</a></li>
</ul><li>7.5.   <a href="#rfc.section.7.5">"Block"</a></li>
<ul><li>7.5.1.   <a href="#rfc.section.7.5.1">"BlockPreamble"</a></li>
<li>7.5.2.   <a href="#rfc.section.7.5.2">"BlockStatistics"</a></li>
<li>7.5.3.   <a href="#rfc.section.7.5.3">"BlockTables"</a></li>
</ul><li>7.6.   <a href="#rfc.section.7.6">"QueryResponse"</a></li>
<ul><li>7.6.1.   <a href="#rfc.section.7.6.1">"ResponseProcessingData"</a></li>
<li>7.6.2.   <a href="#rfc.section.7.6.2">"QueryResponseExtended"</a></li>
</ul><li>7.7.   <a href="#rfc.section.7.7">"AddressEventCount"</a></li>
<li>7.8.   <a href="#rfc.section.7.8">"MalformedMessage"</a></li>
</ul><li>8.   <a href="#rfc.section.8">Malformed messages</a></li>
<li>9.   <a href="#rfc.section.9">C-DNS to PCAP</a></li>
<ul><li>9.1.   <a href="#rfc.section.9.1">Name compression</a></li>
</ul><li>10.   <a href="#rfc.section.10">Data collection</a></li>
<ul><li>10.1.   <a href="#rfc.section.10.1">Matching algorithm</a></li>
<li>10.2.   <a href="#rfc.section.10.2">Message identifiers</a></li>
<ul><li>10.2.1.   <a href="#rfc.section.10.2.1">Primary ID (required)</a></li>
<li>10.2.2.   <a href="#rfc.section.10.2.2">Secondary ID (optional)</a></li>
</ul><li>10.3.   <a href="#rfc.section.10.3">Algorithm parameters</a></li>
<li>10.4.   <a href="#rfc.section.10.4">Algorithm requirements</a></li>
<li>10.5.   <a href="#rfc.section.10.5">Algorithm limitations</a></li>
<li>10.6.   <a href="#rfc.section.10.6">Workspace</a></li>
<li>10.7.   <a href="#rfc.section.10.7">Output</a></li>
<li>10.8.   <a href="#rfc.section.10.8">Post processing</a></li>
</ul><li>11.   <a href="#rfc.section.11">Implementation guidance</a></li>
<ul><li>11.1.   <a href="#rfc.section.11.1">Optional data</a></li>
<li>11.2.   <a href="#rfc.section.11.2">Trailing data in TCP</a></li>
<li>11.3.   <a href="#rfc.section.11.3">Limiting collection of RDATA</a></li>
</ul><li>12.   <a href="#rfc.section.12">Implementation status</a></li>
<ul><li>12.1.   <a href="#rfc.section.12.1">DNS-STATS Compactor</a></li>
</ul><li>13.   <a href="#rfc.section.13">IANA considerations</a></li>
<li>14.   <a href="#rfc.section.14">Security considerations</a></li>
<li>15.   <a href="#rfc.section.15">Acknowledgements</a></li>
<li>16.   <a href="#rfc.section.16">Changelog</a></li>
<li>17.   <a href="#rfc.references">References</a></li>
<ul><li>17.1.   <a href="#rfc.references.1">Normative References</a></li>
<li>17.2.   <a href="#rfc.references.2">Informative References</a></li>
</ul><li>Appendix A.   <a href="#rfc.appendix.A">CDDL</a></li>
<li>Appendix B.   <a href="#rfc.appendix.B">DNS Name compression example</a></li>
<ul><li>B.1.   <a href="#rfc.appendix.B.1">NSD compression algorithm</a></li>
<li>B.2.   <a href="#rfc.appendix.B.2">Knot Authoritative compression algorithm</a></li>
<li>B.3.   <a href="#rfc.appendix.B.3">Observed differences</a></li>
</ul><li>Appendix C.   <a href="#rfc.appendix.C">Comparison of Binary Formats</a></li>
<ul><li>C.1.   <a href="#rfc.appendix.C.1">Comparison with full PCAP files</a></li>
<li>C.2.   <a href="#rfc.appendix.C.2">Simple versus block coding</a></li>
<li>C.3.   <a href="#rfc.appendix.C.3">Binary versus text formats</a></li>
<li>C.4.   <a href="#rfc.appendix.C.4">Performance</a></li>
<li>C.5.   <a href="#rfc.appendix.C.5">Conclusions</a></li>
<li>C.6.   <a href="#rfc.appendix.C.6">Block size choice</a></li>
</ul><li><a href="#rfc.authors">Authors' Addresses</a></li>


  </ul>

  <h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a></h1>
<p id="rfc.section.1.p.1">There has long been a need to collect DNS queries and responses on authoritative and recursive name servers for monitoring and analysis.  This data is used in a number of ways including traffic monitoring, analyzing network attacks and "day in the life" (DITL) <a href="#ditl">[ditl]</a> analysis.  </p>
<p id="rfc.section.1.p.2">A wide variety of tools already exist that facilitate the collection of DNS traffic data, such as DSC <a href="#dsc">[dsc]</a>, packetq <a href="#packetq">[packetq]</a>, dnscap <a href="#dnscap">[dnscap]</a> and dnstap <a href="#dnstap">[dnstap]</a>.  However, there is no standard exchange format for large DNS packet captures.  The PCAP <a href="#pcap">[pcap]</a> or PCAP-NG <a href="#pcapng">[pcapng]</a> formats are typically used in practice for packet captures, but these file formats can contain a great deal of additional information that is not directly pertinent to DNS traffic analysis and thus unnecessarily increases the capture file size.  </p>
<p id="rfc.section.1.p.3">There has also been work on using text based formats to describe DNS packets such as <a href="#I-D.daley-dnsxml">[I-D.daley-dnsxml]</a>, <a href="#I-D.hoffman-dns-in-json">[I-D.hoffman-dns-in-json]</a>, but these are largely aimed at producing convenient representations of single messages.  </p>
<p id="rfc.section.1.p.4">Many DNS operators may receive hundreds of thousands of queries per second on a single name server instance so a mechanism to minimize the storage size (and therefore upload overhead) of the data collected is highly desirable.  </p>
<p id="rfc.section.1.p.5">The format described in this document, C-DNS (Compacted-DNS), focusses on the problem of capturing and storing large packet capture files of DNS traffic. with the following goals in mind: </p>
<p/>

<ul>
  <li>Minimize the file size for storage and transmission</li>
  <li>Minimizing the overhead of producing the packet capture file and the cost of any further (general purpose) compression of the file</li>
</ul>

<p> </p>
<p id="rfc.section.1.p.7">This document contains: </p>
<p/>

<ul>
  <li>A discussion of the some common use cases in which such DNS data is collected <a href="#data-collection-use-cases">Section 3</a></li>
  <li>A discussion of the major design considerations in developing an efficient data representation for collections of DNS messages <a href="#design-considerations">Section 4</a></li>
  <li>A description of why CBOR <a href="#RFC7049">[RFC7049]</a> was chosen for this format <a href="#choice-of-cbor">Section 5</a></li>
  <li>A conceptual overview of the C-DNS format <a href="#cdns-format-conceptual-overview">Section 6</a></li>
  <li>The definition of the C-DNS format for the collection of DNS messages <a href="#cdns-format-detailed-description">Section 7</a>.</li>
  <li>Notes on converting C-DNS data to PCAP format <a href="#cdns-to-pcap">Section 9</a></li>
  <li>Some high level implementation considerations for applications designed to produce C-DNS <a href="#data-collection">Section 10</a></li>
</ul>

<p> </p>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#terminology" id="terminology">Terminology</a></h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.  </p>
<p id="rfc.section.2.p.2">"Packet" refers to individual IPv4 or IPv6 packets. Typically these are UDP, but may be constructed from a TCP packet. "Message", unless otherwise qualified, refers to a DNS payload extracted from a UDP or TCP data stream.  </p>
<p id="rfc.section.2.p.3">The parts of DNS messages are named as they are in <a href="#RFC1035">[RFC1035]</a>. In specific, the DNS message has five sections: Header, Question, Answer, Authority, and Additional.  </p>
<p id="rfc.section.2.p.4">Pairs of DNS messages are called a Query and a Response.  </p>
<h1 id="rfc.section.3"><a href="#rfc.section.3">3.</a> <a href="#data-collection-use-cases" id="data-collection-use-cases">Data collection use cases</a></h1>
<p id="rfc.section.3.p.1">In an ideal world, it would be optimal to collect full packet captures of all packets going in or out of a name server. However, there are several design choices or other limitations that are common to many DNS installations and operators.  </p>
<p/>

<ul>
  <li>DNS servers are hosted in a variety of situations <ul><li>Self-hosted servers</li><li>Third party hosting (including multiple third parties)</li><li>Third party hardware (including multiple third parties)</li></ul></li>
  <li>Data is collected under different conditions <ul><li>On well-provisioned servers running in a steady state</li><li>On heavily loaded servers</li><li>On virtualized servers</li><li>On servers that are under DoS attack</li><li>On servers that are unwitting intermediaries in DoS attacks</li></ul></li>
  <li>Traffic can be collected via a variety of mechanisms <ul><li>On the same hardware as the name server itself</li><li>Using a network tap on an adjacent host to listen to DNS traffic</li><li>Using port mirroring to listen from another host</li></ul></li>
  <li>The capabilities of data collection (and upload) networks vary <ul><li>Out-of-band networks with the same capacity as the in-band network</li><li>Out-of-band networks with less capacity than the in-band network</li><li>Everything being on the in-band network</li></ul></li>
</ul>

<p> </p>
<p id="rfc.section.3.p.3">Thus, there is a wide range of use cases from very limited data collection environments (third party hardware, servers that are under attack, packet capture on the name server itself and no out-of-band network) to "limitless" environments (self hosted, well provisioned servers, using a network tap or port mirroring with an out-of-band networks with the same capacity as the in-band network).  In the former, it is infeasible to reliably collect full packet captures, especially if the server is under attack. In the latter case, collection of full packet captures may be reasonable.  </p>
<p id="rfc.section.3.p.4">As a result of these restrictions, the C-DNS data format was designed with the most limited use case in mind such that: </p>
<p/>

<ul>
  <li>data collection will occur on the same hardware as the name server itself</li>
  <li>collected data will be stored on the same hardware as the name server itself, at least temporarily</li>
  <li>collected data being returned to some central analysis system will use the same network interface as the DNS queries and responses</li>
  <li>there can be multiple third party servers involved</li>
</ul>

<p> </p>
<p id="rfc.section.3.p.6">Because of these considerations, a major factor in the design of the format is minimal storage size of the capture files.  </p>
<p id="rfc.section.3.p.7">Another significant consideration for any application that records DNS traffic is that the running of the name server software and the transmission of DNS queries and responses are the most important jobs of a name server; capturing data is not.  Any data collection system co-located with the name server needs to be intelligent enough to carefully manage its CPU, disk, memory and network utilization. This leads to designing a format that requires a relatively low overhead to produce and minimizes the requirement for further potentially costly compression.  </p>
<p id="rfc.section.3.p.8">However, it was also essential that interoperability with less restricted infrastructure was maintained. In particular, it is highly desirable that the collection format should facilitate the re-creation of common formats (such as PCAP) that are as close to the original as is realistic given the restrictions above.  </p>
<h1 id="rfc.section.4"><a href="#rfc.section.4">4.</a> <a href="#design-considerations" id="design-considerations">Design considerations</a></h1>
<p id="rfc.section.4.p.1">This section presents some of the major design considerations used in the development of the C-DNS format.  </p>
<p/>

<ol>
  <li>The basic unit of data is a combined DNS Query and the associated Response (a "Q/R data item"). The same structure will be used for unmatched Queries and Responses. Queries without Responses will be captured omitting the response data. Responses without queries will be captured omitting the Query data (but using the Question section from the response, if present, as an identifying QNAME).  <ul><li>Rationale: A Query and Response represents the basic level of a clients interaction with the server.  Also, combining the Query and Response into one item often reduces storage requirements due to commonality in the data of the two messages.</li></ul></li>
  <li>All top level fields in each Q/R data item will be optional.  <ul><li>Rationale: Different users will have different requirements for data to be available for analysis.  Users with minimal requirements should not have to pay the cost of recording full data, however this will limit the ability to perform certain kinds of data analysis and also reconstruct packet captures.  For example, omitting the resource records from a Response will reduce the C-DNS file size, and in principle responses can be synthesized if there is enough context.</li></ul></li>
  <li>Multiple Q/R data items will be collected into blocks in the format. Common data in a block will be abstracted and referenced from individual Q/R data items by indexing. The maximum number of Q/R data items in a block will be configurable.  <ul><li>Rationale: This blocking and indexing provides a significant reduction in the volume of file data generated.  Although this introduces complexity, it provides compression of the data that makes use of knowledge of the DNS message structure.</li><li>It is anticipated that the files produced can be subject to further compression using general purpose compression tools.  Measurements show that blocking significantly reduces the CPU required to perform such strong compression. See <a href="#simple-versus-block-coding">Appendix C.2</a>.</li><li>[TODO: Further discussion of commonality between DNS messages e.g. common query signatures, a finite set of valid responses from authoritatives]</li></ul></li>
  <li>Traffic metadata can optionally be included in each block. Specifically, counts of some types of non-DNS packets (e.g. ICMP, TCP resets) sent to the server may be of interest.</li>
  <li>The wire format content of malformed DNS messages can optionally be recorded.  <ul><li>Rationale: Any structured capture format that does not capture the DNS payload byte for byte will be limited to some extent in that it cannot represent "malformed" DNS messages (see <a href="#malformed-messages">Section 8</a>). Only those messages that can be fully parsed and transformed into the structured format can be fully represented. Therefore it can greatly aid downstream analysis to have the wire format of the malformed DNS messages available directly in the C-DNS file.  Note, however, this can result in rather misleading statistics. For example, a malformed query which cannot be represented in the C-DNS format will lead to the (well formed) DNS responses with error code FORMERR appearing as 'unmatched'.</li></ul></li>
</ol>

<p> </p>
<h1 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#choice-of-cbor" id="choice-of-cbor">Choice of CBOR</a></h1>
<p id="rfc.section.5.p.1">This document presents a detailed format description using CBOR, the Concise Binary Object Representation defined in <a href="#RFC7049">[RFC7049]</a>.  </p>
<p id="rfc.section.5.p.2">The choice of CBOR was made taking a number of factors into account.  </p>
<p/>

<ul>
  <li>CBOR is a binary representation, and thus is economical in storage space.</li>
  <li>Other binary representations were investigated, and whilst all had attractive features, none had a significant advantage over CBOR. See <a href="#comparison-of-binary-formats">Appendix C</a> for some discussion of this.</li>
  <li>CBOR is an IETF standard and familiar to IETF participants. It is based on the now-common ideas of lists and objects, and thus requires very little familiarization for those in the wider industry.</li>
  <li>CBOR is a simple format, and can easily be implemented from scratch if necessary. More complex formats require library support which may present problems on unusual platforms.</li>
  <li>CBOR can also be easily converted to text formats such as JSON (<a href="#RFC7159">[RFC7159]</a>) for debugging and other human inspection requirements.</li>
  <li>CBOR data schemas can be described using CDDL <a href="#I-D.ietf-cbor-cddl">[I-D.ietf-cbor-cddl]</a>.</li>
</ul>

<p> </p>
<h1 id="rfc.section.6"><a href="#rfc.section.6">6.</a> <a href="#cdns-format-conceptual-overview" id="cdns-format-conceptual-overview">C-DNS format conceptual overview</a></h1>
<p id="rfc.section.6.p.1">The following figures show purely schematic representations of the C-DNS format to convey the high-level structure of the C-DNS format. <a href="#cdns-format-detailed-description">Section 7</a> provides a detailed discussion of the CBOR representation and individual elements.  </p>
<p><a href="https://github.com/dns-stats/draft-dns-capture-format/blob/master/draft-06/cdns_format.png">Figure showing the C-DNS format (PNG)</a> </p>
<p><a href="https://github.com/dns-stats/draft-dns-capture-format/blob/master/draft-06/cdns_format.svg">Figure showing the C-DNS format (SVG)</a> </p>
<p><a href="https://github.com/dns-stats/draft-dns-capture-format/blob/master/draft-06/qr_data_format.png">Figure showing the Query/Response data item and Block Tables format (PNG)</a> </p>
<p><a href="https://github.com/dns-stats/draft-dns-capture-format/blob/master/draft-06/qr_data_format.svg">Figure showing the Query/Response item and Block Tables format (SVG)</a> </p>
<p id="rfc.section.6.p.6">A C-DNS file begins with a file header containing a File Type Identifier and a File Preamble. The File Preamble contains information on the file Format Version and an array of Block Parameters items (the contents of which include Collection and Storage Parameters used for one or more blocks).  </p>
<p id="rfc.section.6.p.7">The file header is followed by a series of data Blocks.  </p>
<p id="rfc.section.6.p.8">A Block consists of a Block Preamble item, some Block Statistics for the traffic stored within the Block and then various arrays of common data collectively called the Block Tables. This is then followed by an array of the Query/Response data items detailing the queries and responses stored within the Block. The array of Query/Response data items is in turn followed by the Address/Event Counts data items (an array of per-client counts of particular IP events) and then Malformed Message data items (an array of malformed messages that stored in the Block).  </p>
<p id="rfc.section.6.p.9">The exact nature of the DNS data will affect what block size is the best fit, however sample data for a root server indicated that block sizes up to 10,000 Q/R data items give good results. See <a href="#block-size-choice">Appendix C.6</a> for more details.  </p>
<h1 id="rfc.section.6.1"><a href="#rfc.section.6.1">6.1.</a> <a href="#block-parameters" id="block-parameters">Block Parameters</a></h1>
<p id="rfc.section.6.1.p.1">The details of the Block Parameters items are not shown in the diagrams but are discussed here for context.  </p>
<p id="rfc.section.6.1.p.2">An array of Block Parameters items is stored in the File Preamble (with a minimum of one item at index 0); a Block Parameters item consists of a collection of Storage and Collection Parameters that applies to any given Block.  An array is used in order to support use cases such as wanting to merge C-DNS files from different sources. The Block Preamble item then contains an optional index for the Block Parameters item that applies for that Block; if not present the index defaults to 0. Hence, in effect, a global Block Parameters item is defined which can then be overridden per Block.  </p>
<h1 id="rfc.section.6.2"><a href="#rfc.section.6.2">6.2.</a> <a href="#storage-parameters" id="storage-parameters">Storage Parameters</a></h1>
<p id="rfc.section.6.2.p.1">The Block Parameters item includes a Storage Parameters item - this contains information about the specific data fields stored in the C-DNS file.  </p>
<p id="rfc.section.6.2.p.2">These parameters include: </p>
<p/>

<ul>
  <li>The sub-second timing resolution used by the data.</li>
  <li>Information (hints) on which optional data items can be expected to appear in the data. See <a href="#optional-data-items">Section 6.2.1</a>.</li>
  <li>Recorded OPCODES and RR types. See <a href="#optional-rrs-and-opcodes">Section 6.2.2</a>.</li>
  <li>Flags indicating, for example, whether the data is sampled or anonymised.  See <a href="#storage-flags">Section 6.2.3</a>.</li>
  <li>Client and server IPv4 and IPv6 address prefixes. See <a href="#ip-address-storage">Section 6.2.4</a></li>
</ul>

<p> </p>
<h1 id="rfc.section.6.2.1"><a href="#rfc.section.6.2.1">6.2.1.</a> <a href="#optional-data-items" id="optional-data-items">Optional data items</a></h1>
<p id="rfc.section.6.2.1.p.1">To enable applications to store data to their precise requirements in as space-efficient manner as possible, all fields in the following arrays are optional: </p>
<p/>

<ul>
  <li>Query/Response</li>
  <li>Query Signature</li>
  <li>Malformed messages</li>
</ul>

<p> </p>
<p id="rfc.section.6.2.1.p.3">In other words, an application can choose to omit any data item that is not required for its use case. In addition, implementations may be configured to not record all RRs, or only record messages with certain OPCODES.  </p>
<p id="rfc.section.6.2.1.p.4">This does, however, mean that a consumer of a C-DNS file faces two problems: </p>
<p/>

<ol>
  <li>How can it quickly determine whether a file contains the data items it requires to complete a particular task (e.g. reconstructing query traffic or performing a specific piece of data analysis)?</li>
  <li>How can it determine if a data item is not present because it was <ul><li>explicitly not recorded, or</li><li>either was not present in the original data stream or the data item was not available to the collecting application?</li></ul></li>
</ol>

<p> </p>
<p id="rfc.section.6.2.1.p.6">For example, an application capturing C-DNS data from within a nameserver implementation is unlikely to be able to record the Client Hoplimit. Or, if there is no query ARCount recorded and no query OPT RDATA recorded, is that because no query contained an OPT RR, or because that data was not stored? </p>
<p id="rfc.section.6.2.1.p.7">The Storage Parameters therefore also contains a Storage Hints item which specifies whether the encoder of the file recorded each data item if it was present.  An application decoding that file can then use these to quickly determine whether the input data is rich enough for its needs.  </p>
<p id="rfc.section.6.2.1.p.8">QUESTION: Should the items within certain tables also be optional e.g. within the RR table should all of Name index, ClassType, TTL and RDATA be optional? </p>
<h1 id="rfc.section.6.2.2"><a href="#rfc.section.6.2.2">6.2.2.</a> <a href="#optional-rrs-and-opcodes" id="optional-rrs-and-opcodes">Optional RRs and OPCODES</a></h1>
<p id="rfc.section.6.2.2.p.1">Also included in the Storage Parameters is an explicit array of the RR types and OPCODES that were recorded. Using an explicit array removes any ambiguity about whether the OPCODE/RR type was not recognised by the collecting implementation or whether it was specifically configured not to record it.  </p>
<p id="rfc.section.6.2.2.p.2">In the case of RR records, each record must be parsable, including parsing the record RDATA, to determine whether it is correctly formed. Otherwise it has to be regarded as at least potentially partially malformed. See <a href="#malformed-messages">Section 8</a> for further discussion of storing partially parsed messages.  </p>
<p id="rfc.section.6.2.2.p.3">For the case of unrecognised OPCODES the message may be parsable (for example, if it has a format similar enough to the one described in <a href="#RFC1035">[RFC1035]</a>) or it may not. See <a href="#malformed-messages">Section 8</a> for further discussion of storing partially parsed messages.  </p>
<h1 id="rfc.section.6.2.3"><a href="#rfc.section.6.2.3">6.2.3.</a> <a href="#storage-flags" id="storage-flags">Storage flags</a></h1>
<p id="rfc.section.6.2.3.p.1">The Storage Parameters contains flags that can be used to indicate if: </p>
<p/>

<ul>
  <li>the data is anonymised,</li>
  <li>the data is produced from sample data, or</li>
  <li>names in the data have been normalised (converted to uniform case).</li>
</ul>

<p> </p>
<p id="rfc.section.6.2.3.p.3">The Storage Parameters also contains optional fields holding details of the sampling method used and the anonymisation method used. It is RECOMMENDED these fields contain URIs pointing to resources describing the methods used.  </p>
<h1 id="rfc.section.6.2.4"><a href="#rfc.section.6.2.4">6.2.4.</a> <a href="#ip-address-storage" id="ip-address-storage">IP Address storage</a></h1>
<p id="rfc.section.6.2.4.p.1">The format contains fields to indicate if only IP prefixes were stored.  If IP address prefixes are given, only the prefix bits of addresses are stored. For example, if a client IPv4 prefix of 16 is specified, a client address of 192.0.2.1 will be stored as 0xc000 (192.0), reducing address storage space requirements.  </p>
<h1 id="rfc.section.7"><a href="#rfc.section.7">7.</a> <a href="#cdns-format-detailed-description" id="cdns-format-detailed-description">C-DNS format detailed description</a></h1>
<p id="rfc.section.7.p.1">The CDDL definition for the C-DNS format is given in <a href="#cddl">Appendix A</a>.  </p>
<h1 id="rfc.section.7.1"><a href="#rfc.section.7.1">7.1.</a> <a href="#map-quantities-and-indexes" id="map-quantities-and-indexes">Map quantities and indexes</a></h1>
<p id="rfc.section.7.1.p.1">All map keys are integers with values specified in the CDDL. String keys would significantly bloat the file size.  </p>
<p id="rfc.section.7.1.p.2">All key values specified are positive integers under 24, so their CBOR representation is a single byte. Positive integer values not currently used as keys in a map are reserved for use in future standard extensions.  </p>
<p id="rfc.section.7.1.p.3">Implementations may choose to add additional implementation-specific entries to any map. Negative integer map keys are reserved for these values. Key values from -1 to -24 also have a single byte CBOR representation, so such implementation-specific extensions are not at any space efficiency disadvantage.  </p>
<p id="rfc.section.7.1.p.4">An item described as an index is the index of the data item in the referenced array.  Indexes are 0-based.  </p>
<h1 id="rfc.section.7.2"><a href="#rfc.section.7.2">7.2.</a> <a href="#tabular-representation" id="tabular-representation">Tabular representation</a></h1>
<p id="rfc.section.7.2.p.1">The following sections present the C-DNS specification in tabular format with a detailed description of each item.  </p>
<p id="rfc.section.7.2.p.2">In all quantities that contain bit flags, bit 0 indicates the least significant bit, i.e. flag <samp>n</samp> in quantity <samp>q</samp> is on if <samp>(q &amp; (1 &lt;&lt; n)) != 0</samp>.  </p>
<p id="rfc.section.7.2.p.3">For the sake of readability, all type and field names defined in the CDDL definition are shown in double quotes. Type names are by convention camel case (e.g. <samp>BlockTable</samp>), field names are lower-case with hyphens (e.g. <samp>block-tables</samp>).  </p>
<p id="rfc.section.7.2.p.4">For the sake of brevity, the following conventions are used in the tables: </p>
<p/>

<ul>
  <li>The column O marks whether items in a map are optional.  <ul><li>O - Optional. The item may be omitted.</li><li>M - Mandatory. The item must be present.</li></ul></li>
  <li>The column T gives the CBOR data type of the item.  <ul><li>U - Unsigned integer</li><li>I - Signed integer</li><li>B - Byte string</li><li>T - Text string</li><li>M - Map</li><li>A - Array</li></ul></li>
</ul>

<p> </p>
<p id="rfc.section.7.2.p.6">In the case of maps and arrays, more information on the type of each value, include the CDDL definition name if applicable, is given in the description.  </p>
<h1 id="rfc.section.7.3"><a href="#rfc.section.7.3">7.3.</a> <a href="#file" id="file">"File"</a></h1>
<p id="rfc.section.7.3.p.1">A C-DNS file has an outer structure <samp>File</samp>, a map that contains the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">file-type-id</td>
      <td class="center">M</td>
      <td class="center">T</td>
      <td class="left">String "C-DNS" identifying the file type.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">file-preamble</td>
      <td class="center">M</td>
      <td class="center">M</td>
      <td class="left">Version and parameter information for the whole file. Map of type <samp>FilePreamble</samp>, see <a href="#filepreamble">Section 7.4</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">file-blocks</td>
      <td class="center">M</td>
      <td class="center">A</td>
      <td class="left">Array of items of type <samp>Block</samp>, see <a href="#block">Section 7.5</a>. The array may be empty if the file contains no data.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.4"><a href="#rfc.section.7.4">7.4.</a> <a href="#filepreamble" id="filepreamble">"FilePreamble"</a></h1>
<p id="rfc.section.7.4.p.1">Information about data in the file. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">major-format-version</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">Unsigned integer '1'. The major version of format used in file.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">minor-format-version</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">Unsigned integer '0'. The minor version of format used in file.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">private-version</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Version indicator available for private use by applications.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">block-parameters</td>
      <td class="center">M</td>
      <td class="center">A</td>
      <td class="left">Array of items of type <samp>BlockParameters</samp>, see <a href="#blockparameters">Section 7.4.1</a>. The array must contain at least one entry. (The <samp>block-parameters-index</samp> item in each <samp>BlockPreamble</samp> indicates which array entry applies to that <samp>Block</samp>.)</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.4.1"><a href="#rfc.section.7.4.1">7.4.1.</a> <a href="#blockparameters" id="blockparameters">"BlockParameters"</a></h1>
<p id="rfc.section.7.4.1.p.1">Parameters relating to data storage and collection which apply to one or more items of type <samp>Block</samp>. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">storage-parameters</td>
      <td class="center">M</td>
      <td class="center">M</td>
      <td class="left">Parameters relating to data storage in a <samp>Block</samp> item.  Map of type <samp>StorageParameters</samp>, see <a href="#storageparameters">Section 7.4.1.1</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">collection-parameters</td>
      <td class="center">O</td>
      <td class="center">M</td>
      <td class="left">Parameters relating to collection of the data in a <samp>Block</samp> item. Map of type <samp>CollectionParameters</samp>, see <a href="#collectionparameters">Section 7.4.2</a>.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.4.1.1"><a href="#rfc.section.7.4.1.1">7.4.1.1.</a> <a href="#storageparameters" id="storageparameters">"StorageParameters"</a></h1>
<p id="rfc.section.7.4.1.1.p.1">Parameters relating to how data is stored in the items of type <samp>Block</samp>. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">ticks-per-second</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">Sub-second timing is recorded in ticks. This specifies the number of ticks in a second.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">max-block-items</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">The maximum number of items stored in any of the arrays in a <samp>Block</samp> item (Q/R items, address event counts or malformed messages). An indication to a decoder of the resources needed to process the file.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">storage-hints</td>
      <td class="center">M</td>
      <td class="center">M</td>
      <td class="left">Collection of hints as to which fields are present in the arrays that have optional fields. Map of type <samp>StorageHints</samp>, see <a href="#storagehints">Section 7.4.1.1.1</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">opcodes</td>
      <td class="center">M</td>
      <td class="center">A</td>
      <td class="left">Array of OPCODES (unsigned integers) recorded by the collection application. See <a href="#optional-rrs-and-opcodes">Section 6.2.2</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">rr-types</td>
      <td class="center">M</td>
      <td class="center">A</td>
      <td class="left">Array of RR types (unsigned integers) recorded by the collection application. See <a href="#optional-rrs-and-opcodes">Section 6.2.2</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">storage-flags</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Bit flags indicating attributes of stored data.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 0. The data has been anonymised.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 1. The data is sampled data.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 2. Names have been normalised (converted to uniform case).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">client-address -prefix-ipv4</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">IPv4 client address prefix length. If specified, only the address prefix bits are stored.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">client-address -prefix-ipv6</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">IPv6 client address prefix length. If specified, only the address prefix bits are stored.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">server-address -prefix-ipv4</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">IPv4 server address prefix length. If specified, only the address prefix bits are stored.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">server-address -prefix-ipv6</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">IPv6 server address prefix length. If specified, only the address prefix bits are stored.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">sampling-method</td>
      <td class="center">O</td>
      <td class="center">T</td>
      <td class="left">Information on the sampling method used. See <a href="#storage-flags">Section 6.2.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">anonymisation-method</td>
      <td class="center">O</td>
      <td class="center">T</td>
      <td class="left">Information on the anonymisation method used. See <a href="#storage-flags">Section 6.2.3</a>.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.4.1.1.1"><a href="#rfc.section.7.4.1.1.1">7.4.1.1.1.</a> <a href="#storagehints" id="storagehints">"StorageHints"</a></h1>
<p id="rfc.section.7.4.1.1.1.p.1">An indicator of which fields the collecting application stores in the arrays with optional fields. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">query-response -hints</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">Hints indicating which <samp>QueryResponse</samp> fields are stored, see section <a href="#queryresponse">Section 7.6</a>. If the field is stored the bit is set.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 0. time-offset</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 1. client-address-index</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 2. client-port</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 3. transaction-id</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 4. qr-signature-index</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 5. client-hoplimit</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 6. response-delay</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 7. query-name-index</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 8. query-size</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 9. response-size</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 10. response-processing-data</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 11. query-question-sections</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 12. query-answer-sections</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 13. query-authority-sections</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 14. query-additional-sections</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 15. response-answer-sections</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 16. response-authority-sections</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 17. response-additional-sections</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-response -signature-hints</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">Hints indicating which <samp>QueryResponseSignature</samp> fields are stored, see section <a href="#queryresponsesignature">Section 7.5.3.2</a>. If the field is stored the bit is set.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 0. server-address</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 1. server-port</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 2. qr-transport-flags</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 3. qr-type</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 4. qr-sig-flags</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 5. query-opcode</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 6. dns-flags</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 7. query-rcode</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 8. query-class-type</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 9. query-qdcount</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 10. query-ancount</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 11. query-nscount</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 12. query-arcount</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 13. query-edns-version</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 14. query-udp-size</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 15. query-opt-rdata</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 16. response-rcode</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">rr-hints</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">Hints indicating which optional <samp>RR</samp> fields are stored, see section <a href="#rr">Section 7.5.3.4</a>. If the data type is stored the bit is set.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 0. ttl</td>
    </tr>
    <tr>
      <td class="left">other-data-hints</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">Hints indicating which other data types are stored. If the data type is stored the bit is set.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 0. malformed-messages</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 1. address-event-counts</td>
    </tr>
  </tbody>
</table>
<p id="rfc.section.7.4.1.1.1.p.2">TODO: Revise non-QueryResponse hints to cover optional fields in malformed message data maps.  </p>
<h1 id="rfc.section.7.4.2"><a href="#rfc.section.7.4.2">7.4.2.</a> <a href="#collectionparameters" id="collectionparameters">"CollectionParameters"</a></h1>
<p id="rfc.section.7.4.2.p.1">Parameters relating to how data in the file was collected.  </p>
<p id="rfc.section.7.4.2.p.2">These parameters have no default. If they do not appear, nothing can be inferred about their value.  </p>
<p id="rfc.section.7.4.2.p.3">A map containing the following items: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">query-timeout</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">To be matched with a query, a response must arrive within this number of seconds.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">skew-timeout</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The network stack may report a response before the corresponding query. A response is not considered to be missing a query until after this many micro-seconds.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">snaplen</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Collect up to this many bytes per packet.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">promisc</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">1 if promiscuous mode was enabled on the interface, 0 otherwise.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">interfaces</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array of identifiers (of type text string) of the interfaces used for collection.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">server-addresses</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array of server collection IP addresses (of type byte string). Hint for downstream analysers; does not affect collection.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">vlan-ids</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array of identifiers (of type unsigned integer) of VLANs selected for collection.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">filter</td>
      <td class="center">O</td>
      <td class="center">T</td>
      <td class="left"><samp>tcpdump</samp> <a href="#pcap">[pcap]</a> style filter for input.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">generator-id</td>
      <td class="center">O</td>
      <td class="center">T</td>
      <td class="left">String identifying the collection method.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">host-id</td>
      <td class="center">O</td>
      <td class="center">T</td>
      <td class="left">String identifying the collecting host. Empty if converting an existing packet capture file.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.5"><a href="#rfc.section.7.5">7.5.</a> <a href="#block" id="block">"Block"</a></h1>
<p id="rfc.section.7.5.p.1">Container for data with common collection and and storage parameters. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">block-preamble</td>
      <td class="center">M</td>
      <td class="center">M</td>
      <td class="left">Overall information for the <samp>Block</samp> item. Map of type <samp>BlockPreamble</samp>, see <a href="#blockpreamble">Section 7.5.1</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">block-statistics</td>
      <td class="center">O</td>
      <td class="center">M</td>
      <td class="left">Statistics about the <samp>Block</samp> item. Map of type <samp>BlockStatistics</samp>, see <a href="#blockstatistics">Section 7.5.2</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">block-tables</td>
      <td class="center">O</td>
      <td class="center">M</td>
      <td class="left">The arrays containing data referenced by individual <samp>QueryResponse</samp> or <samp>MalformedMessage</samp> items. Map of type <samp>BlockTables</samp>, see <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-responses</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Details of individual DNS Q/R data items. Array of items of type <samp>QueryResponse</samp>, see <a href="#queryresponse">Section 7.6</a>. If present, the array must not be empty.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">address-event -counts</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Per client counts of ICMP messages and TCP resets. Array of items of type <samp>AddressEventCount</samp>, see <a href="#addresseventcount">Section 7.7</a>. If present, the array must not be empty.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">malformed-messages</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Details of malformed DNS messages. Array of items of type <samp>MalformedMessage</samp>, see <a href="#malformedmessage">Section 7.8</a>. If present, the array must not be empty.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.5.1"><a href="#rfc.section.7.5.1">7.5.1.</a> <a href="#blockpreamble" id="blockpreamble">"BlockPreamble"</a></h1>
<p id="rfc.section.7.5.1.p.1">Overall information for a <samp>Block</samp> item. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">earliest-time</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">A timestamp (2 unsigned integers, <samp>Timestamp</samp>) for the earliest record in the <samp>Block</samp> item. The first integer is the number of seconds since the Posix epoch (<samp>time_t</samp>). The second integer is the number of ticks since the start of the second. This timestamp can only be omitted if all block items containing a time offset from the start of the block also omit the timestamp.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">block-parameters -index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index of the item in the <samp>block-parameters</samp> array (in the <samp>file-premable</samp> item) applicable to this block. If not present, index 0 is used. See <a href="#blockparameters">Section 7.4.1</a>.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.5.2"><a href="#rfc.section.7.5.2">7.5.2.</a> <a href="#blockstatistics" id="blockstatistics">"BlockStatistics"</a></h1>
<p id="rfc.section.7.5.2.p.1">Basic statistical information about a <samp>Block</samp> item. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">total-messages</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Total number of DNS messages processed from the input traffic stream during collection of data in this <samp>Block</samp> item.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">total-pairs</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Total number of Q/R data items in this <samp>Block</samp> item.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">unmatched-queries</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Number of unmatched queries in this <samp>Block</samp> item.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">unmatched-responses</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Number of unmatched responses in this <samp>Block</samp> item.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">malformed-messages</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Number of malformed messages found in input for this <samp>Block</samp> item.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.5.3"><a href="#rfc.section.7.5.3">7.5.3.</a> <a href="#blocktables" id="blocktables">"BlockTables"</a></h1>
<p id="rfc.section.7.5.3.p.1">Arrays containing data referenced by individual <samp>QueryResponse</samp> or <samp>MalformedMessage</samp> items in this <samp>Block</samp>.  Each element is an array which, if present, must not be empty.  </p>
<p id="rfc.section.7.5.3.p.2">An item in the <samp>qlist</samp> array contains indexes to values in the <samp>qrr</samp> array. Therefore, if <samp>qlist</samp> is present, <samp>qrr</samp> must also be present. Similarly, if <samp>rrlist</samp> is present, <samp>rr</samp> must also be present.  </p>
<p id="rfc.section.7.5.3.p.3">The map contains the following items: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">ip-address</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array of IP addresses, in network byte order (of type byte string). If client or server address prefixes are set, only the address prefix bits are stored. Each string is therefore up to 4 bytes long for an IPv4 address, or up to 16 bytes long for an IPv6 address. See <a href="#storageparameters">Section 7.4.1.1</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">classtype</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array of RR class and type information. Type is <samp>ClassType</samp>, see <a href="#classtype">Section 7.5.3.1</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">name-rdata</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array where each entry is the contents of a single NAME or RDATA (of type byte string). Note that NAMEs, and labels within RDATA contents, are full domain names or labels; no DNS style name compression is used on the individual names/labels within the format.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">qr-sig</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array Q/R data item signatures. Type is <samp>QueryResponseSignature</samp>, see <a href="#queryresponsesignature">Section 7.5.3.2</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">qlist</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array of type <samp>QuestionList</samp>. A <samp>QuestionList</samp> is an array of unsigned integers, indexes to <samp>Question</samp> items in the <samp>qrr</samp> array.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">qrr</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array of type <samp>Question</samp>. Each entry is the contents of a single question, where a question is the second or subsequent question in a query. See <a href="#question">Section 7.5.3.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">rrlist</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array of type <samp>RRList</samp>. An <samp>RRList</samp> is an array of unsigned integers, indexes to <samp>RR</samp> items in the <samp>rr</samp> array.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">rr</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array of type <samp>RR</samp>. Each entry is the contents of a single RR. See <a href="#rr">Section 7.5.3.4</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">malformed-message -data</td>
      <td class="center">O</td>
      <td class="center">A</td>
      <td class="left">Array of the contents of malformed messages.  Array of type <samp>MalformedMessageData</samp>, see <a href="#malformedmessagedata">Section 7.5.3.5</a>.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.5.3.1"><a href="#rfc.section.7.5.3.1">7.5.3.1.</a> <a href="#classtype" id="classtype">"ClassType"</a></h1>
<p id="rfc.section.7.5.3.1.p.1">RR class and type information. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">type</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">TYPE value.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">class</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">CLASS value.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.5.3.2"><a href="#rfc.section.7.5.3.2">7.5.3.2.</a> <a href="#queryresponsesignature" id="queryresponsesignature">"QueryResponseSignature"</a></h1>
<p id="rfc.section.7.5.3.2.p.1">Elements of a Q/R data item that are often common between multiple individual Q/R data items. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">server-address -index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the item in the <samp>ip-address</samp> array of the server IP address. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">server-port</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The server port.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">qr-transport-flags</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Bit flags describing the transport used to service the query.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 0. IP version. 0 = IPv4, 1 = IPv6</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 1-4. Transport. 0 = UDP, 1 = TCP, 2 = TLS, 3 = DTLS.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 5. Trailing bytes in query payload. The DNS query message in the UDP or TCP payload was followed by some additional bytes, which were discarded.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">qr-type</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Type of Query/Response transaction.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">0 = Stub. A query from a stub resolver.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">1 = Client. An incoming query to a recursive resolver.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">2 = Resolver. A query sent from a recursive resolver to an authorative resolver.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">3 = Authorative. A query to an authorative resolver.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">4 = Forwarder. A query sent from a recursive resolver to an upstream recursive resolver.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">5 = Tool. A query sent to a server by a server tool.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">qr-sig-flags</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Bit flags indicating information present in this Q/R data item.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 0. 1 if a Query is present.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 1. 1 if a Response is present.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 2. 1 if one or more Question is present.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 3. 1 if a Query is present and it has an OPT Resource Record.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 4. 1 if a Response is present and it has an OPT Resource Record.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 5. 1 if a Response is present but has no Question.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-opcode</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Query OPCODE.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">qr-dns-flags</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Bit flags with values from the Query and Response DNS flags. Flag values are 0 if the Query or Response is not present.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 0. Query Checking Disabled (CD).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 1. Query Authenticated Data (AD).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 2. Query reserved (Z).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 3. Query Recursion Available (RA).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 4. Query Recursion Desired (RD).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 5. Query TrunCation (TC).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 6. Query Authoritative Answer (AA).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 7. Query DNSSEC answer OK (DO).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 8. Response Checking Disabled (CD).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 9. Response Authenticated Data (AD).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 10. Response reserved (Z).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 11. Response Recursion Available (RA).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 12. Response Recursion Desired (RD).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 13. Response TrunCation (TC).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 14. Response Authoritative Answer (AA).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-rcode</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Query RCODE. If the Query contains OPT, this value incorporates any EXTENDED_RCODE_VALUE.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-classtype -index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index to the item in the the <samp>classtype</samp> array of the CLASS and TYPE of the first Question. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-qd-count</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The QDCOUNT in the Query, or Response if no Query present.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-an-count</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Query ANCOUNT.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-ns-count</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Query NSCOUNT.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-ar-count</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Query ARCOUNT.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">edns-version</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The Query EDNS version.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">udp-buf-size</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The Query EDNS sender's UDP payload size.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">opt-rdata-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>name-rdata</samp> array  of the OPT RDATA. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">response-rcode</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Response RCODE. If the Response contains OPT, this value incorporates any EXTENDED_RCODE_VALUE.</td>
    </tr>
  </tbody>
</table>
<p id="rfc.section.7.5.3.2.p.2">QUESTION: Currently we collect OPT RDATA as a blob as this is consistent with and re-uses the generic mechanism for RDATA storage. Should we break individual EDNS(0) options into Option code and data and store the data separately in a new array within the Block type? This would potentially allow exploitation of option data commonality.  </p>
<h1 id="rfc.section.7.5.3.3"><a href="#rfc.section.7.5.3.3">7.5.3.3.</a> <a href="#question" id="question">"Question"</a></h1>
<p id="rfc.section.7.5.3.3.p.1">Details on individual Questions in a Question section. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">name-index</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>name-rdata</samp> array of the QNAME. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">classtype-index</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>classtype</samp> array of the CLASS and TYPE of the Question. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.5.3.4"><a href="#rfc.section.7.5.3.4">7.5.3.4.</a> <a href="#rr" id="rr">"RR"</a></h1>
<p id="rfc.section.7.5.3.4.p.1">Details on individual Resource Records in RR sections. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">name-index</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>name-rdata</samp> array of the NAME. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">classtype-index</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>classtype</samp> array of the CLASS and TYPE of the RR. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">ttl</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The RR Time to Live.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">rdata-index</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>name-rdata</samp> array of the RR RDATA. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.5.3.5"><a href="#rfc.section.7.5.3.5">7.5.3.5.</a> <a href="#malformedmessagedata" id="malformedmessagedata">"MalformedMessageData"</a></h1>
<p id="rfc.section.7.5.3.5.p.1">Details on malformed message items in this <samp>Block</samp> item. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">server-address -index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>ip-address</samp> array of the server IP address. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">server-port</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The server port.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">mm-transport-flags</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Bit flags describing the transport used to service the query. Bit 0 is the least significant bit.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 0. IP version. 0 = IPv4, 1 = IPv6</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 1-4. Transport. 0 = UDP, 1 = TCP, 2 = TLS, 3 = DTLS.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">mm-payload</td>
      <td class="center">O</td>
      <td class="center">B</td>
      <td class="left">The payload (raw bytes) of the DNS message.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.6"><a href="#rfc.section.7.6">7.6.</a> <a href="#queryresponse" id="queryresponse">"QueryResponse"</a></h1>
<p id="rfc.section.7.6.p.1">Details on individual Q/R data items.  </p>
<p id="rfc.section.7.6.p.2">Note that there is no requirement that the elements of the <samp>query-responses</samp> array are presented in strict chronological order.  </p>
<p id="rfc.section.7.6.p.3">A map containing the following items: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">time-offset</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Q/R timestamp as an offset in ticks from <samp>earliest-time</samp>. The timestamp is the timestamp of the Query, or the Response if there is no Query.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">client-address-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>ip-address</samp> array of the client IP address. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">client-port</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The client port.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">transaction-id</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">DNS transaction identifier.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">qr-signature-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>qr-sig</samp> array of the <samp>QueryResponseSignature</samp> item. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">client-hoplimit</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The IPv4 TTL or IPv6 Hoplimit from the Query packet.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">response-delay</td>
      <td class="center">O</td>
      <td class="center">I</td>
      <td class="left">The time difference between Query and Response, in ticks. Only present if there is a query and a response. The delay can be negative if the network stack/capture library returns packets out of order.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-name-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>name-rdata</samp> array of the item containing the QNAME for the first Question. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-size</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">DNS query message size (see below).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">response-size</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">DNS query message size (see below).</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">response-processing -data</td>
      <td class="center">O</td>
      <td class="center">M</td>
      <td class="left">Data on response processing. Map of type <samp>ResponseProcessingData</samp>, see <a href="#responseprocessingdata">Section 7.6.1</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">query-extended</td>
      <td class="center">O</td>
      <td class="center">M</td>
      <td class="left">Extended Query data. Map of type <samp>QueryResponseExtended</samp>, see <a href="#queryresponseextended">Section 7.6.2</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">response-extended</td>
      <td class="center">O</td>
      <td class="center">M</td>
      <td class="left">Extended Response data. Map of type <samp>QueryResponseExtended</samp>, see <a href="#queryresponseextended">Section 7.6.2</a>.</td>
    </tr>
  </tbody>
</table>
<p id="rfc.section.7.6.p.4">The <samp>query-size</samp> and <samp>response-size</samp> fields hold the DNS message size. For UDP this is the size of the UDP payload that contained the DNS message. For TCP it is the size of the DNS message as specified in the two-byte message length header. Trailing bytes with queries are routinely observed in traffic to authoritative servers and this value allows a calculation of how many trailing bytes were present.  </p>
<h1 id="rfc.section.7.6.1"><a href="#rfc.section.7.6.1">7.6.1.</a> <a href="#responseprocessingdata" id="responseprocessingdata">"ResponseProcessingData"</a></h1>
<p id="rfc.section.7.6.1.p.1">Information on the server processing that produced the response. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">bailiwick-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>name-rdata</samp> array of the owner name for the response bailiwick. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">processing-flags</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Flags relating to response processing.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">Bit 0. 1 if the response came from cache.</td>
    </tr>
  </tbody>
</table>
<p id="rfc.section.7.6.1.p.2">QUESTION: Should this be an item in the <samp>QueryResponseSignature</samp>? </p>
<h1 id="rfc.section.7.6.2"><a href="#rfc.section.7.6.2">7.6.2.</a> <a href="#queryresponseextended" id="queryresponseextended">"QueryResponseExtended"</a></h1>
<p id="rfc.section.7.6.2.p.1">Extended data on the Q/R data item.  </p>
<p id="rfc.section.7.6.2.p.2">Each item in the map is present only if collection of the relevant details is configured.  </p>
<p id="rfc.section.7.6.2.p.3">A map containing the following items: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">question-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>qlist</samp> array of the entry listing any second and subsequent Questions in the Question section for the Query or Response. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">answer-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>rrlist</samp> array of the entry listing the Answer Resource Record sections for the Query or Response. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">authority-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>rrlist</samp> array of the entry listing the Authority Resource Record sections for the Query or Response. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">additional-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>rrlist</samp> array of the entry listing the Additional Resource Record sections for the Query or Response. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.7"><a href="#rfc.section.7.7">7.7.</a> <a href="#addresseventcount" id="addresseventcount">"AddressEventCount"</a></h1>
<p id="rfc.section.7.7.p.1">Counts of various IP related events relating to traffic with individual client addresses. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">ae-type</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">The type of event. The following events types are currently defined:</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">0. TCP reset.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">1. ICMP time exceeded.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">2. ICMP destination unreachable.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">3. ICMPv6 time exceeded.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">4. ICMPv6 destination unreachable.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left">5. ICMPv6 packet too big.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">ae-code</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">A code relating to the event.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">ae-address-index</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>ip-address</samp> array of the client address. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">ae-count</td>
      <td class="center">M</td>
      <td class="center">U</td>
      <td class="left">The number of occurrences of this event during the block collection period.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.7.8"><a href="#rfc.section.7.8">7.8.</a> <a href="#malformedmessage" id="malformedmessage">"MalformedMessage"</a></h1>
<p id="rfc.section.7.8.p.1">Details of malformed messages. See <a href="#malformed-messages">Section 8</a>. A map containing the following: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Field</th>
      <th class="center">O</th>
      <th class="center">T</th>
      <th class="left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">time-offset</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">Message timestamp as an offset in ticks from <samp>earliest-time</samp>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">client-address-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>ip-address</samp> array of the client IP address. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">client-port</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The client port.</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="center"/>
      <td class="center"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="left">message-data-index</td>
      <td class="center">O</td>
      <td class="center">U</td>
      <td class="left">The index in the <samp>malformed-message-data</samp> array of the message data for this message. See <a href="#blocktables">Section 7.5.3</a>.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.8"><a href="#rfc.section.8">8.</a> <a href="#malformed-messages" id="malformed-messages">Malformed messages</a></h1>
<p id="rfc.section.8.p.1">In the context of generating a C-DNS file it is assumed that only those DNS messages which can be parsed to produce a well-formed DNS message are stored in the C-DNS format and that all other messages will be recorded (if at all) as malformed messages.  </p>
<p id="rfc.section.8.p.2">Parsing a well-formed message means as a minimum: </p>
<p/>

<ul>
  <li>The packet has a well-formed 12 byte DNS Header</li>
  <li>The section counts are consistent with the section contents</li>
  <li>All of the resource records can be parsed</li>
</ul>

<p> </p>
<p id="rfc.section.8.p.4">In principle, packets that do not meet these criteria could be classified into two categories: </p>
<p/>

<ul>
  <li>Partially malformed: those packets which can be decoded sufficiently to extract <ul><li>a well-formed 12 byte DNS header (and therefore a DNS transaction ID)</li><li>the first Question in the Question section if QDCOUNT is greater than 0</li></ul></li>
</ul>

<p> </p>
<p id="rfc.section.8.p.6">but suffer other issues while parsing. This is the minimum information required to attempt Query/Response matching as described in <a href="#matching-algorithm">Section 10.1</a>.  </p>
<p/>

<ul>
  <li>Completely malformed: those packets that cannot be decoded to this extent.</li>
</ul>

<p> </p>
<p id="rfc.section.8.p.8">An open question is whether there is value in attempting to process partially malformed messages in an analogous manner to well formed messages in terms of attempting to match them with the corresponding query or response. This could be done by creating 'placeholder' records during Query/Response matching with just the information extracted as above. If the packet were then matched the resulting C-DNS Q/R data item would include flags to indicate a malformed query or response or both record (in addition to capturing the wire format of the packet).  </p>
<p id="rfc.section.8.p.9">An advantage of this would be that it would result in more meaningful statistics about matched packets because, for example, some partially malformed queries could be matched to responses. However it would only apply to those queries where the first Question is well formed. It could also simplify the downstream analysis of C-DNS files and the reconstruction of packet streams from C-DNS.  </p>
<p id="rfc.section.8.p.10">A disadvantage is that this adds complexity to the Query/Response matching and data representation, could potentially lead to false matches and some additional statistics would be required (e.g. counts for matched-partially-malformed, unmatched-partially-malformed, completely-malformed).  </p>
<p id="rfc.section.8.p.11">NOTE: Note that within these definitions a message that contained an unrecognised OPCODE or RR code would be treated as malformed. It may be the case that the OPCODE/RR is not recognised just because the implementation does not support it yet, rather than it not being standardized. For the case of unrecognised OPCODES the message may be parsable (for example, if it has a format similar enough to the one described in <a href="#RFC1035">[RFC1035]</a>) or it may not. Similarly for unrecognised RR types the RDATA can still be stored, but the collector will not be able to process it to remove, for example, name compression pointers.  </p>
<p id="rfc.section.8.p.12">QUESTION: There has been no feedback to date requesting further work on the processing partially malformed messages. The editors are inclined not to include it in this version. It could be the subject of a future extension.  </p>
<h1 id="rfc.section.9"><a href="#rfc.section.9">9.</a> <a href="#cdns-to-pcap" id="cdns-to-pcap">C-DNS to PCAP</a></h1>
<p id="rfc.section.9.p.1">It is possible to re-construct PCAP files from the C-DNS format in a lossy fashion.  Some of the issues with reconstructing both the DNS payload and the full packet stream are outlined here.  </p>
<p id="rfc.section.9.p.2">The reconstruction depends on whether or not all the optional sections of both the query and response were captured in the C-DNS file.  Clearly, if they were not all captured, the reconstruction will be imperfect.  </p>
<p id="rfc.section.9.p.3">Even if all sections of the response were captured, one cannot reconstruct the DNS response payload exactly due to the fact that some DNS names in the message on the wire may have been compressed.  <a href="#name-compression">Section 9.1</a> discusses this is more detail.  </p>
<p id="rfc.section.9.p.4">Some transport information is not captured in the C-DNS format. For example, the following aspects of the original packet stream cannot be re-constructed from the C-DNS format: </p>
<p/>

<ul>
  <li>IP fragmentation</li>
  <li>TCP stream information: <ul><li>Multiple DNS messages may have been sent in a single TCP segment</li><li>A DNS payload may have be split across multiple TCP segments</li><li>Multiple DNS messages may have be sent on a single TCP session</li></ul></li>
  <li>Malformed DNS messages if the wire format is not recorded</li>
  <li>Any Non-DNS messages that were in the original packet stream e.g. ICMP</li>
</ul>

<p> </p>
<p id="rfc.section.9.p.6">Simple assumptions can be made on the reconstruction: fragmented and DNS-over-TCP messages can be reconstructed into single packets and a single TCP session can be constructed for each TCP packet.  </p>
<p id="rfc.section.9.p.7">Additionally, if malformed messages and Non-DNS packets are captured separately, they can be merged with packet captures reconstructed from C-DNS to produce a more complete packet stream.  </p>
<h1 id="rfc.section.9.1"><a href="#rfc.section.9.1">9.1.</a> <a href="#name-compression" id="name-compression">Name compression</a></h1>
<p id="rfc.section.9.1.p.1">All the names stored in the C-DNS format are full domain names; no DNS style name compression is used on the individual names within the format. Therefore when reconstructing a packet, name compression must be used in order to reproduce the on the wire representation of the packet.  </p>
<p><a href="#RFC1035">[RFC1035]</a> name compression works by substituting trailing sections of a name with a reference back to the occurrence of those sections earlier in the message.  Not all name server software uses the same algorithm when compressing domain names within the responses. Some attempt maximum recompression at the expense of runtime resources, others use heuristics to balance compression and speed and others use different rules for what is a valid compression target.  </p>
<p id="rfc.section.9.1.p.3">This means that responses to the same question from different name server software which match in terms of DNS payload content (header, counts, RRs with name compression removed) do not necessarily match byte-for-byte on the wire.  </p>
<p id="rfc.section.9.1.p.4">Therefore, it is not possible to ensure that the DNS response payload is reconstructed byte-for-byte from C-DNS data. However, it can at least, in principle, be reconstructed to have the correct payload length (since the original response length is captured) if there is enough knowledge of the commonly implemented name compression algorithms. For example, a simplistic approach would be to try each algorithm in turn to see if it reproduces the original length, stopping at the first match. This would not guarantee the correct algorithm has been used as it is possible to match the length whilst still not matching the on the wire bytes but, without further information added to the C-DNS data, this is the best that can be achieved.  </p>
<p><a href="#dns-name-compression-example">Appendix B</a> presents an example of two different compression algorithms used by well-known name server software.  </p>
<h1 id="rfc.section.10"><a href="#rfc.section.10">10.</a> <a href="#data-collection" id="data-collection">Data collection</a></h1>
<p id="rfc.section.10.p.1">This section describes a non-normative proposed algorithm for the processing of a captured stream of DNS queries and responses and matching queries/responses where possible.  </p>
<p id="rfc.section.10.p.2">For the purposes of this discussion, it is assumed that the input has been pre-processed such that: </p>
<p/>

<ol>
  <li>All IP fragmentation reassembly, TCP stream reassembly, and so on, has already been performed</li>
  <li>Each message is associated with transport metadata required to generate the Primary ID (see <a href="#primary-id">Section 10.2.1</a>)</li>
  <li>Each message has a well-formed DNS header of 12 bytes and (if present) the first Question in the Question section can be parsed to generate the Secondary ID (see below). As noted earlier, this requirement can result in a malformed query being removed in the pre-processing stage, but the correctly formed response with RCODE of FORMERR being present.</li>
</ol>

<p> </p>
<p id="rfc.section.10.p.4">DNS messages are processed in the order they are delivered to the application.  It should be noted that packet capture libraries do not necessary provide packets in strict chronological order.  </p>
<p id="rfc.section.10.p.5">TODO: Discuss the corner cases resulting from this in more detail.  </p>
<h1 id="rfc.section.10.1"><a href="#rfc.section.10.1">10.1.</a> <a href="#matching-algorithm" id="matching-algorithm">Matching algorithm</a></h1>
<p id="rfc.section.10.1.p.1">A schematic representation of the algorithm for matching Q/R data items is shown in the following diagram: </p>
<p><a href="https://github.com/dns-stats/draft-dns-capture-format/blob/master/draft-06/packet_matching.png">Figure showing the Query/Response matching algorithm format (PNG)</a> </p>
<p><a href="https://github.com/dns-stats/draft-dns-capture-format/blob/master/draft-06/packet_matching.svg">Figure showing the Query/Response matching algorithm format (SVG)</a> </p>
<p id="rfc.section.10.1.p.4">Further details of the algorithm are given in the following sections.  </p>
<h1 id="rfc.section.10.2"><a href="#rfc.section.10.2">10.2.</a> <a href="#message-identifiers" id="message-identifiers">Message identifiers</a></h1>
<h1 id="rfc.section.10.2.1"><a href="#rfc.section.10.2.1">10.2.1.</a> <a href="#primary-id" id="primary-id">Primary ID (required)</a></h1>
<p id="rfc.section.10.2.1.p.1">A Primary ID is constructed for each message. It is composed of the following data: </p>
<p/>

<ol>
  <li>Source IP Address</li>
  <li>Destination IP Address</li>
  <li>Source Port</li>
  <li>Destination Port</li>
  <li>Transport</li>
  <li>DNS Message ID</li>
</ol>

<p> </p>
<h1 id="rfc.section.10.2.2"><a href="#rfc.section.10.2.2">10.2.2.</a> <a href="#secondary-id" id="secondary-id">Secondary ID (optional)</a></h1>
<p id="rfc.section.10.2.2.p.1">If present, the first Question in the Question section is used as a secondary ID for each message. Note that there may be well formed DNS queries that have a QDCOUNT of 0, and some responses may have a QDCOUNT of 0 (for example, responses with RCODE=FORMERR or NOTIMP). In this case the secondary ID is not used in matching.  </p>
<h1 id="rfc.section.10.3"><a href="#rfc.section.10.3">10.3.</a> <a href="#algorithm-parameters" id="algorithm-parameters">Algorithm parameters</a></h1>
<p/>

<ol>
  <li>Query timeout</li>
  <li>Skew timeout</li>
</ol>

<p> </p>
<h1 id="rfc.section.10.4"><a href="#rfc.section.10.4">10.4.</a> <a href="#algorithm-requirements" id="algorithm-requirements">Algorithm requirements</a></h1>
<p id="rfc.section.10.4.p.1">The algorithm is designed to handle the following input data: </p>
<p/>

<ol>
  <li>Multiple queries with the same Primary ID (but different Secondary ID) arriving before any responses for these queries are seen.</li>
  <li>Multiple queries with the same Primary and Secondary ID arriving before any responses for these queries are seen.</li>
  <li>Queries for which no later response can be found within the specified timeout.</li>
  <li>Responses for which no previous query can be found within the specified timeout.</li>
</ol>

<p> </p>
<h1 id="rfc.section.10.5"><a href="#rfc.section.10.5">10.5.</a> <a href="#algorithm-limitations" id="algorithm-limitations">Algorithm limitations</a></h1>
<p id="rfc.section.10.5.p.1">For cases 1 and 2 listed in the above requirements, it is not possible to unambiguously match queries with responses.  This algorithm chooses to match to the earliest query with the correct Primary and Secondary ID.  </p>
<h1 id="rfc.section.10.6"><a href="#rfc.section.10.6">10.6.</a> <a href="#workspace" id="workspace">Workspace</a></h1>
<p id="rfc.section.10.6.p.1">A FIFO structure is used to hold the Q/R data items during processing.  </p>
<h1 id="rfc.section.10.7"><a href="#rfc.section.10.7">10.7.</a> <a href="#output" id="output">Output</a></h1>
<p id="rfc.section.10.7.p.1">The output is a list of Q/R data items. Both the Query and Response elements are optional in these items, therefore Q/R data items have one of three types of content: </p>
<p/>

<ol>
  <li>A matched pair of query and response messages</li>
  <li>A query message with no response</li>
  <li>A response message with no query</li>
</ol>

<p> </p>
<p id="rfc.section.10.7.p.3">The timestamp of a list item is that of the query for cases 1 and 2 and that of the response for case 3.  </p>
<h1 id="rfc.section.10.8"><a href="#rfc.section.10.8">10.8.</a> <a href="#post-processing" id="post-processing">Post processing</a></h1>
<p id="rfc.section.10.8.p.1">When ending capture, all remaining entries in the Q/R data item FIFO should be treated as timed out queries.  </p>
<h1 id="rfc.section.11"><a href="#rfc.section.11">11.</a> <a href="#implementation-guidance" id="implementation-guidance">Implementation guidance</a></h1>
<p id="rfc.section.11.p.1">Whilst this document makes no specific recommendations with respect to Canonical CBOR (see Section 3.9 of [RFC7049]) the following guidance may be of use to implementors.  </p>
<p id="rfc.section.11.p.2">Adherence to the first two rules given in Section 3.9 of [RFC7049] will minimise file sizes.  </p>
<p id="rfc.section.11.p.3">Adherence to the last two rules given in Section 3.9 of [RFC7049] for all maps and arrays would unacceptably constrain implementations, for example, in the use case of real-time data collection in constrained environments.  </p>
<p id="rfc.section.11.p.4">NOTE: With this clarification to the use of Canonical CBOR, we could consider re-ordering fields in maps to improve readability.  </p>
<h1 id="rfc.section.11.1"><a href="#rfc.section.11.1">11.1.</a> <a href="#optional-data" id="optional-data">Optional data</a></h1>
<p id="rfc.section.11.1.p.1">When decoding data some items required for a particular function the consumer wishes to perform may be missing. Consumers should consider providing configurable default values to be used in place of the missing values in their output.  </p>
<h1 id="rfc.section.11.2"><a href="#rfc.section.11.2">11.2.</a> <a href="#trailing-data-in-tcp" id="trailing-data-in-tcp">Trailing data in TCP</a></h1>
<p id="rfc.section.11.2.p.1">TODO: Clarify the impact of processing wire captures which includes trailing data in TCP. What will appear as trailing data, what will appear as malformed messages? </p>
<h1 id="rfc.section.11.3"><a href="#rfc.section.11.3">11.3.</a> <a href="#limiting-collection-of-rdata" id="limiting-collection-of-rdata">Limiting collection of RDATA</a></h1>
<p id="rfc.section.11.3.p.1">Implementations should consider providing a configurable maximum RDATA size for capture , for example, to avoid memory issues when confronted with large XFR records.  </p>
<h1 id="rfc.section.12"><a href="#rfc.section.12">12.</a> <a href="#implementation-status" id="implementation-status">Implementation status</a></h1>
<p id="rfc.section.12.p.1">[Note to RFC Editor: please remove this section and reference to <a href="#RFC7942">[RFC7942]</a> prior to publication.] </p>
<p id="rfc.section.12.p.2">This section records the status of known implementations of the protocol defined by this specification at the time of posting of this Internet-Draft, and is based on a proposal described in <a href="#RFC7942">[RFC7942]</a>.  The description of implementations in this section is intended to assist the IETF in its decision processes in progressing drafts to RFCs.  Please note that the listing of any individual implementation here does not imply endorsement by the IETF.  Furthermore, no effort has been spent to verify the information presented here that was supplied by IETF contributors.  This is not intended as, and must not be construed to be, a catalog of available implementations or their features.  Readers are advised to note that other implementations may exist.  </p>
<p id="rfc.section.12.p.3">According to <a href="#RFC7942">[RFC7942]</a>, "this will allow reviewers and working groups to assign due consideration to documents that have the benefit of running code, which may serve as evidence of valuable experimentation and feedback that have made the implemented protocols more mature.  It is up to the individual working groups to use this information as they see fit".  </p>
<h1 id="rfc.section.12.1"><a href="#rfc.section.12.1">12.1.</a> <a href="#dnsstats-compactor" id="dnsstats-compactor">DNS-STATS Compactor</a></h1>
<p id="rfc.section.12.1.p.1">ICANN/Sinodun IT have developed an open source implementation called DNS-STATS Compactor.  The Compactor is a suite of tools which can capture DNS traffic (from either a network interface or a PCAP file) and store it in the Compacted-DNS (C-DNS) file format. PCAP files for the captured traffic can also be reconstructed. See <a href="https://github.com/dns-stats/compactor/wiki">Compactor</a>.  </p>
<p id="rfc.section.12.1.p.2">This implementation: </p>
<p/>

<ul>
  <li>is mature but has only been deployed for testing in a single environment so is not yet classified as production ready.</li>
  <li>covers the whole of the specification described in the -03 draft with the exception of support for malformed messages (<a href="#malformed-messages">Section 8</a>) and pico second time resolution.  (Note: this implementation does allow malformed messages to be dumped to a PCAP file).</li>
  <li>is released under the Mozilla Public License Version 2.0.</li>
  <li>has a users mailing list available, see <a href="https://mm.dns-stats.org/mailman/listinfo/dns-stats-users">dns-stats-users</a>.</li>
</ul>

<p> </p>
<p id="rfc.section.12.1.p.4">There is also some discussion of issues encountered during development available at <a href="https://www.sinodun.com/2017/06/compressing-pcap-files/">Compressing Pcap Files</a> and <a href="https://www.sinodun.com/2017/06/more-on-debian-jessieubuntu-trusty-packet-capture-woes/">Packet Capture</a>.  </p>
<p id="rfc.section.12.1.p.5">This information was last updated on 29th of June 2017.  </p>
<h1 id="rfc.section.13"><a href="#rfc.section.13">13.</a> <a href="#iana-considerations" id="iana-considerations">IANA considerations</a></h1>
<p id="rfc.section.13.p.1">None </p>
<h1 id="rfc.section.14"><a href="#rfc.section.14">14.</a> <a href="#security-considerations" id="security-considerations">Security considerations</a></h1>
<p id="rfc.section.14.p.1">Any control interface MUST perform authentication and encryption.  </p>
<p id="rfc.section.14.p.2">Any data upload MUST be authenticated and encrypted.  </p>
<h1 id="rfc.section.15"><a href="#rfc.section.15">15.</a> <a href="#acknowledgements" id="acknowledgements">Acknowledgements</a></h1>
<p id="rfc.section.15.p.1">The authors wish to thank CZ.NIC, in particular Tomas Gavenciak, for many useful discussions on binary formats, compression and packet matching. Also Jan Vcelak and Wouter Wijngaards for discussions on name compression and Paul Hoffman for a detailed review of the document and the C-DNS CDDL.  </p>
<p id="rfc.section.15.p.2">Thanks also to Robert Edmonds, Jerry Lundstr&#246;m, Richard Gibson, Stephane Bortzmeyer and many other members of DNSOP for review.  </p>
<p id="rfc.section.15.p.3">Also, Miek Gieben for <a href="https://github.com/miekg/mmark">mmark</a> </p>
<h1 id="rfc.section.16"><a href="#rfc.section.16">16.</a> <a href="#changelog" id="changelog">Changelog</a></h1>
<p id="rfc.section.16.p.1">draft-ietf-dnsop-dns-capture-format-06 </p>
<p/>

<ul>
  <li>Correct BlockParameters type to map</li>
  <li>Make RR ttl optional</li>
  <li>Add storage flag indicating name normalisation</li>
  <li>Add storage parameter fields for sampling and anonymisation methods</li>
  <li>Editorial clarifications and improvements</li>
</ul>

<p> </p>
<p id="rfc.section.16.p.3">draft-ietf-dnsop-dns-capture-format-05 </p>
<p/>

<ul>
  <li>Make all data items in Q/R, QuerySignature and Malformed Message arrays optional</li>
  <li>Re-structure the FilePreamble and ConfigurationParameters into BlockParameters</li>
  <li>BlockParameters has separate Storage and Collection Parameters</li>
  <li>Storage Parameters includes information on what optional fields are present, and flags specifying anonymisation or sampling</li>
  <li>Addresses can now be stored as prefixes.</li>
  <li>Switch to using a variable sub-second timing granularity</li>
  <li>Add response bailiwick and query response type</li>
  <li>Add specifics of how to record malformed messages</li>
  <li>Add implementation guidance</li>
  <li>Improve terminology and naming consistency</li>
</ul>

<p> </p>
<p id="rfc.section.16.p.5">draft-ietf-dnsop-dns-capture-format-04 </p>
<p/>

<ul>
  <li>Correct query-d0 to query-do in CDDL</li>
  <li>Clarify that map keys are unsigned integers</li>
  <li>Add Type to Class/Type table</li>
  <li>Clarify storage format in section 7.12</li>
</ul>

<p> </p>
<p id="rfc.section.16.p.7">draft-ietf-dnsop-dns-capture-format-03 </p>
<p/>

<ul>
  <li>Added an Implementation Status section</li>
</ul>

<p> </p>
<p id="rfc.section.16.p.9">draft-ietf-dnsop-dns-capture-format-02 </p>
<p/>

<ul>
  <li>Update qr_data_format.png to match CDDL</li>
  <li>Editorial clarifications and improvements</li>
</ul>

<p> </p>
<p id="rfc.section.16.p.11">draft-ietf-dnsop-dns-capture-format-01 </p>
<p/>

<ul>
  <li>Many editorial improvements by Paul Hoffman</li>
  <li>Included discussion of malformed message handling</li>
  <li>Improved Appendix C on Comparison of Binary Formats</li>
  <li>Now using C-DNS field names in the tables in section 8</li>
  <li>A handful of new fields included (CDDL updated)</li>
  <li>Timestamps now include optional picoseconds</li>
  <li>Added details of block statistics</li>
</ul>

<p> </p>
<p id="rfc.section.16.p.13">draft-ietf-dnsop-dns-capture-format-00 </p>
<p/>

<ul>
  <li>Changed dnstap.io to dnstap.info</li>
  <li>qr_data_format.png was cut off at the bottom</li>
  <li>Update authors address</li>
  <li>Improve wording in Abstract</li>
  <li>Changed DNS-STAT to C-DNS in CDDL</li>
  <li>Set the format version in the CDDL</li>
  <li>Added a TODO: Add block statistics</li>
  <li>Added a TODO: Add extend to support pico/nano. Also do this for Time offset and Response delay</li>
  <li>Added a TODO: Need to develop optional representation of malformed messages within C-DNS and what this means for packet matching.  This may influence which fields are optional in the rest of the representation.</li>
  <li>Added section on design goals to Introduction</li>
  <li>Added a TODO: Can Class be optimised?  Should a class of IN be inferred if not present?</li>
</ul>

<p> </p>
<p id="rfc.section.16.p.15">draft-dickinson-dnsop-dns-capture-format-00 </p>
<p/>

<ul>
  <li>Initial commit</li>
</ul>

<p> </p>
<h1 id="rfc.references"><a href="#rfc.references">17.</a> References</h1>
<h1 id="rfc.references.1"><a href="#rfc.references.1">17.1.</a> Normative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="RFC1035">[RFC1035]</b>
      </td>
      <td class="top"><a>Mockapetris, P.</a>, "<a href="http://tools.ietf.org/html/rfc1035">Domain names - implementation and specification</a>", STD 13, RFC 1035, DOI 10.17487/RFC1035, November 1987.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC2119">[RFC2119]</b>
      </td>
      <td class="top"><a>Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7049">[RFC7049]</b>
      </td>
      <td class="top"><a>Bormann, C.</a> and <a>P. Hoffman</a>, "<a href="http://tools.ietf.org/html/rfc7049">Concise Binary Object Representation (CBOR)</a>", RFC 7049, DOI 10.17487/RFC7049, October 2013.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.references.2"><a href="#rfc.references.2">17.2.</a> Informative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="ditl">[ditl]</b>
      </td>
      <td class="top"><a>DNS-OARC</a>, "<a href="https://www.dns-oarc.net/oarc/data/ditl">DITL</a>", 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="dnscap">[dnscap]</b>
      </td>
      <td class="top"><a>DNS-OARC</a>, "<a href="https://www.dns-oarc.net/tools/dnscap">DNSCAP</a>", 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="dnstap">[dnstap]</b>
      </td>
      <td class="top"><a>dnstap.info</a>, "<a href="http://dnstap.info/">dnstap</a>", 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="dsc">[dsc]</b>
      </td>
      <td class="top"><a title="Verisign">Wessels, D.</a> and <a title="DNS-OARC">J. Lundstrom</a>, "<a href="https://www.dns-oarc.net/tools/dsc">DSC</a>", 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.daley-dnsxml">[I-D.daley-dnsxml]</b>
      </td>
      <td class="top"><a>Daley, J.</a>, <a>Morris, S.</a> and <a>J. Dickinson</a>, "<a href="http://tools.ietf.org/html/draft-daley-dnsxml-00">dnsxml - A standard XML representation of DNS data</a>", Internet-Draft draft-daley-dnsxml-00, July 2013.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.hoffman-dns-in-json">[I-D.hoffman-dns-in-json]</b>
      </td>
      <td class="top"><a>Hoffman, P.</a>, "<a href="http://tools.ietf.org/html/draft-hoffman-dns-in-json-13">Representing DNS Messages in JSON</a>", Internet-Draft draft-hoffman-dns-in-json-13, October 2017.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.ietf-cbor-cddl">[I-D.ietf-cbor-cddl]</b>
      </td>
      <td class="top"><a>Birkholz, H.</a>, <a>Vigano, C.</a> and <a>C. Bormann</a>, "<a href="http://tools.ietf.org/html/draft-ietf-cbor-cddl-02">Concise data definition language (CDDL): a notational convention to express CBOR data structures</a>", Internet-Draft draft-ietf-cbor-cddl-02, February 2018.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="packetq">[packetq]</b>
      </td>
      <td class="top"><a>.SE - The Internet Infrastructure Foundation</a>, "<a href="https://github.com/dotse/PacketQ">PacketQ</a>", 2014.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="pcap">[pcap]</b>
      </td>
      <td class="top"><a>tcpdump.org</a>, "<a href="http://www.tcpdump.org/">PCAP</a>", 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="pcapng">[pcapng]</b>
      </td>
      <td class="top"><a href="mailto:tuexen@fh-muenster.de" title="Muenster Univ. of Appl. Sciences">Tuexen, M.</a>, <a href="mailto:fulvio.risso@polito.it" title="Politecnico di Torino">Risso, F.</a>, <a href="mailto:jasper@packet-foo.com" title="Airbus DS CyberSecurity">Bongertz, J.</a>, <a href="mailto:gerald@wireshark.org" title="Wireshark">Combs, G.</a> and <a href="mailto:guy@alum.mit.edu">G. Harris</a>, "<a href="https://github.com/pcapng/pcapng">pcap-ng</a>", 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7159">[RFC7159]</b>
      </td>
      <td class="top"><a>Bray, T.</a>, "<a href="http://tools.ietf.org/html/rfc7159">The JavaScript Object Notation (JSON) Data Interchange Format</a>", RFC 7159, DOI 10.17487/RFC7159, March 2014.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7942">[RFC7942]</b>
      </td>
      <td class="top"><a>Sheffer, Y.</a> and <a>A. Farrel</a>, "<a href="http://tools.ietf.org/html/rfc7942">Improving Awareness of Running Code: The Implementation Status Section</a>", BCP 205, RFC 7942, DOI 10.17487/RFC7942, July 2016.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.appendix.A"><a href="#rfc.appendix.A">Appendix A.</a> <a href="#cddl" id="cddl">CDDL</a></h1>
<pre>
; CDDL specification of the file format for C-DNS,
; which describes a collection of DNS messages and
; traffic meta-data.

;
; The overall structure of a file.
;
File = [
    file-type-id  : tstr .regexp "C-DNS",
    file-preamble : FilePreamble,
    file-blocks   : [* Block],
]

;
; The file preamble.
;
FilePreamble = {
    major-format-version =&gt; uint .eq 1,
    minor-format-version =&gt; uint .eq 0,
    ? private-version    =&gt; uint,
    block-parameters     =&gt; [+ BlockParameters],
}
major-format-version = 0
minor-format-version = 1
private-version      = 2
block-parameters     = 3

BlockParameters = {
    storage-parameters      =&gt; StorageParameters,
    ? collection-parameters =&gt; CollectionParameters,
}
storage-parameters    = 0
collection-parameters = 1

  StorageParameters = {
      ticks-per-second             =&gt; uint,
      max-block-items              =&gt; uint,
      storage-hints                =&gt; StorageHints,
      opcodes                      =&gt; [+ uint],
      rr-types                     =&gt; [+ uint],
      ? storage-flags              =&gt; StorageFlags,
      ? client-address-prefix-ipv4 =&gt; uint,
      ? client-address-prefix-ipv6 =&gt; uint,
      ? server-address-prefix-ipv4 =&gt; uint,
      ? server-address-prefix-ipv6 =&gt; uint,
      ? sampling-method            =&gt; tstr,
      ? anonymisation-method       =&gt; tstr,
  }
  ticks-per-second           = 0
  max-block-items            = 1
  storage-hints              = 2
  opcodes                    = 3
  rr-types                   = 4
  storage-flags              = 5
  client-address-prefix-ipv4 = 6
  client-address-prefix-ipv6 = 7
  server-address-prefix-ipv4 = 8
  server-address-prefix-ipv6 = 9
  sampling-method            = 10
  anonymisation-method       = 11

    ; A hint indicates if the collection method will output the
    ; item or will ignore the item if present.
    StorageHints = {
        query-response-hints           =&gt; QueryResponseHints,
        query-response-signature-hints =&gt; QueryResponseSignatureHints,
        rr-hints                       =&gt; RRHints,
        other-data-hints               =&gt; OtherDataHints,
    }
    query-response-hints           = 0
    query-response-signature-hints = 1
    rr-hints                       = 2
    other-data-hints               = 3

      QueryResponseHintValues = &amp;(
          time-offset                  : 0,
          client-address-index         : 1,
          client-port                  : 2,
          transaction-id               : 3,
          qr-signature-index           : 4,
          client-hoplimit              : 5,
          response-delay               : 6,
          query-name-index             : 7,
          query-size                   : 8,
          response-size                : 9,
          response-processing-data     : 10,
          query-question-sections      : 11,    ; Second &amp; subsequent questions
          query-answer-sections        : 12,
          query-authority-sections     : 13,
          query-additional-sections    : 14,
          response-answer-sections     : 15,
          response-authority-sections  : 16,
          response-additional-sections : 17,
      )
      QueryResponseHints = uint .bits QueryResponseHintValues

      QueryResponseSignatureHintValues =&amp;(
          server-address     : 0,
          server-port        : 1,
          qr-transport-flags : 2,
          qr-type            : 3,
          qr-sig-flags       : 4,
          query-opcode       : 5,
          dns-flags          : 6,
          query-rcode        : 7,
          query-class-type   : 8,
          query-qdcount      : 9,
          query-ancount      : 10,
          query-arcount      : 11,
          query-nscount      : 12,
          query-edns-version : 13,
          query-udp-size     : 14,
          query-opt-rdata    : 15,
          response-rcode     : 16,
      )
      QueryResponseSignatureHints = uint .bits QueryResponseSignatureHintValues

      RRHintValues = &amp;(
          ttl   : 0,
      )
      RRHints = uint .bits RRHintValues

      OtherDataHintValues = &amp;(
          malformed-messages   : 0,
          address-event-counts : 1,
      )
      OtherDataHints = uint .bits OtherDataHintValues

    StorageFlagValues = &amp;(
        anonymised-data      : 0,
        sampled-data         : 1,
        normalised-names     : 2,
    )
    StorageFlags = uint .bits StorageFlagValues

  CollectionParameters = {
      ? query-timeout      =&gt; uint,
      ? skew-timeout       =&gt; uint,
      ? snaplen            =&gt; uint,
      ? promisc            =&gt; uint,
      ? interfaces         =&gt; [+ tstr],
      ? server-addresses   =&gt; [+ IPAddress], ; Hint for later analysis
      ? vlan-ids           =&gt; [+ uint],
      ? filter             =&gt; tstr,
      ? generator-id       =&gt; tstr,
      ? host-id            =&gt; tstr,
  }
  query-timeout      = 0
  skew-timeout       = 1
  snaplen            = 2
  promisc            = 3
  interfaces         = 4
  server-addresses   = 5
  vlan-ids           = 6
  filter             = 7
  generator-id       = 8
  host-id            = 9

;
; Data in the file is stored in Blocks.
;
Block = {
    block-preamble          =&gt; BlockPreamble,
    ? block-statistics      =&gt; BlockStatistics, ; Much of this could be derived
    ? block-tables          =&gt; BlockTables,
    ? query-responses       =&gt; [+ QueryResponse],
    ? address-event-counts  =&gt; [+ AddressEventCount],
    ? malformed-messages    =&gt; [+ MalformedMessage],
}
block-preamble        = 0
block-statistics      = 1
block-tables          = 2
query-responses       = 3
address-event-counts  = 4
malformed-messages    = 5

;
; The (mandatory) preamble to a block.
;
BlockPreamble = {
    ? earliest-time          =&gt; Timestamp,
    ? block-parameters-index =&gt; uint .default 0,
}
earliest-time          = 0
block-parameters-index = 1

; Ticks are subsecond intervals. The number of ticks in a second is file/block
; metadata. Signed and unsigned tick types are defined.
ticks = int
uticks = uint

Timestamp = [
    timestamp-secs   : uint,
    timestamp-uticks : uticks,
]

;
; Statistics about the block contents.
;
BlockStatistics = {
    ? total-messages            =&gt; uint,
    ? total-pairs               =&gt; uint,
    ? total-unmatched-queries   =&gt; uint,
    ? total-unmatched-responses =&gt; uint,
    ? total-malformed-messages  =&gt; uint,
}
total-messages               = 0
total-pairs                  = 1
total-unmatched-queries      = 2
total-unmatched-responses    = 3
total-malformed-messages     = 4

;
; Tables of common data referenced from records in a block.
;
BlockTables = {
    ? ip-address             =&gt; [+ IPAddress],
    ? classtype              =&gt; [+ ClassType],
    ? name-rdata             =&gt; [+ bstr],    ; Holds both Name RDATA and RDATA
    ? qr-sig                 =&gt; [+ QueryResponseSignature],
    ? QuestionTables,
    ? RRTables,
    ? malformed-message-data =&gt; [+ MalformedMessageData],
}
ip-address             = 0
classtype              = 1
name-rdata             = 2
qr-sig                 = 3
qlist                  = 4
qrr                    = 5
rrlist                 = 6
rr                     = 7
malformed-message-data = 8

IPv4Address = bstr .size 4
IPv6Address = bstr .size 16
IPAddress = IPv4Address / IPv6Address

ClassType = {
    type  =&gt; uint,
    class =&gt; uint,
}
type  = 0
class = 1

QueryResponseSignature = {
    ? server-address-index  =&gt; uint,
    ? server-port           =&gt; uint,
    ? qr-transport-flags    =&gt; QueryResponseTransportFlags,
    ? qr-type               =&gt; QueryResponseType,
    ? qr-sig-flags          =&gt; QueryResponseFlags,
    ? query-opcode          =&gt; uint,
    ? qr-dns-flags          =&gt; DNSFlags,
    ? query-rcode           =&gt; uint,
    ? query-classtype-index =&gt; uint,
    ? query-qd-count        =&gt; uint,
    ? query-an-count        =&gt; uint,
    ? query-ns-count        =&gt; uint,
    ? query-ar-count        =&gt; uint,
    ? edns-version          =&gt; uint,
    ? udp-buf-size          =&gt; uint,
    ? opt-rdata-index       =&gt; uint,
    ? response-rcode        =&gt; uint,
}
server-address-index  = 0
server-port           = 1
qr-transport-flags    = 2
qr-type               = 3
qr-sig-flags          = 4
query-opcode          = 5
qr-dns-flags          = 6
query-rcode           = 7
query-classtype-index = 8
query-qd-count        = 9
query-an-count        = 10
query-ns-count        = 12
query-ar-count        = 12
edns-version          = 13
udp-buf-size          = 14
opt-rdata-index       = 15
response-rcode        = 16

  Transport = &amp;(
      udp               : 0,
      tcp               : 1,
      tls               : 2,
      dtls              : 3,
  )

  TransportFlagValues = &amp;(
      ip-version         : 0,     ; 0=IPv4, 1=IPv6
      ; Transport value bits 1-4
  ) / (1..4)
  TransportFlags = uint .bits TransportFlagValues

  QueryResponseTransportFlagValues = &amp;(
      query-trailingdata : 5,
  ) / TransportFlagValues
  QueryResponseTransportFlags = uint .bits QueryResponseTransportFlagValues

  QueryResponseType = &amp;(
      stub      : 0,
      client    : 1,
      resolver  : 2,
      auth      : 3,
      forwarder : 4,
      tool      : 5,
  )

  QueryResponseFlagValues = &amp;(
      has-query               : 0,
      has-reponse             : 1,
      query-has-question      : 2,
      query-has-opt           : 3,
      response-has-opt        : 4,
      response-has-no-question: 5,
  )
  QueryResponseFlags = uint .bits QueryResponseFlagValues

  DNSFlagValues = &amp;(
      query-cd   : 0,
      query-ad   : 1,
      query-z    : 2,
      query-ra   : 3,
      query-rd   : 4,
      query-tc   : 5,
      query-aa   : 6,
      query-do   : 7,
      response-cd: 8,
      response-ad: 9,
      response-z : 10,
      response-ra: 11,
      response-rd: 12,
      response-tc: 13,
      response-aa: 14,
  )
  DNSFlags = uint .bits DNSFlagValues

QuestionTables = (
    qlist =&gt; [+ QuestionList],
    qrr   =&gt; [+ Question]
)

  QuestionList = [+ uint]           ; Index of Question

  Question = {                      ; Second and subsequent questions
      name-index      =&gt; uint,      ; Index to a name in the name-rdata table
      classtype-index =&gt; uint,
  }
  name-index      = 0
  classtype-index = 1

RRTables = (
    rrlist =&gt; [+ RRList],
    rr     =&gt; [+ RR]
)

  RRList = [+ uint]                     ; Index of RR

  RR = {
      name-index      =&gt; uint,          ; Index to a name in the name-rdata table
      classtype-index =&gt; uint,
      ? ttl           =&gt; uint,
      rdata-index     =&gt; uint,          ; Index to RDATA in the name-rdata table
  }
  ; Other map key values already defined above.
  ttl         = 2
  rdata-index = 3

MalformedMessageData = {
    ? server-address-index   =&gt; uint,
    ? server-port            =&gt; uint,
    ? mm-transport-flags     =&gt; TransportFlags,
    ? mm-payload             =&gt; bstr,
}
; Other map key values already defined above.
mm-transport-flags      = 2
mm-payload              = 3

;
; A single query/response pair.
;
QueryResponse = {
    ? time-offset              =&gt; uticks,     ; Time offset from start of block
    ? client-address-index     =&gt; uint,
    ? client-port              =&gt; uint,
    ? transaction-id           =&gt; uint,
    ? qr-signature-index       =&gt; uint,
    ? client-hoplimit          =&gt; uint,
    ? response-delay           =&gt; ticks,
    ? query-name-index         =&gt; uint,
    ? query-size               =&gt; uint,       ; DNS size of query
    ? response-size            =&gt; uint,       ; DNS size of response
    ? response-processing-data =&gt; ResponseProcessingData,
    ? query-extended           =&gt; QueryResponseExtended,
    ? response-extended        =&gt; QueryResponseExtended,
}
time-offset              = 0
client-address-index     = 1
client-port              = 2
transaction-id           = 3
qr-signature-index       = 4
client-hoplimit          = 5
response-delay           = 6
query-name-index         = 7
query-size               = 8
response-size            = 9
response-processing-data = 10
query-extended           = 11
response-extended        = 12

ResponseProcessingData = {
    ? bailiwick-index  =&gt; uint,
    ? processing-flags =&gt; ResponseProcessingFlags,
}
bailiwick-index = 0
processing-flags = 1

  ResponseProcessingFlagValues = &amp;(
      from-cache : 0,
  )
  ResponseProcessingFlags = uint .bits ResponseProcessingFlagValues

QueryResponseExtended = {
    ? question-index   =&gt; uint,       ; Index of QuestionList
    ? answer-index     =&gt; uint,       ; Index of RRList
    ? authority-index  =&gt; uint,
    ? additional-index =&gt; uint,
}
question-index   = 0
answer-index     = 1
authority-index  = 2
additional-index = 3

;
; Address event data.
;
AddressEventCount = {
    ae-type          =&gt; &amp;AddressEventType,
    ? ae-code        =&gt; uint,
    ae-address-index =&gt; uint,
    ae-count         =&gt; uint,
}
ae-type          = 0
ae-code          = 1
ae-address-index = 2
ae-count         = 3

AddressEventType = (
    tcp-reset              : 0,
    icmp-time-exceeded     : 1,
    icmp-dest-unreachable  : 2,
    icmpv6-time-exceeded   : 3,
    icmpv6-dest-unreachable: 4,
    icmpv6-packet-too-big  : 5,
)

;
; Malformed messages.
;
MalformedMessage = {
    ? time-offset           =&gt; uticks,   ; Time offset from start of block
    ? client-address-index  =&gt; uint,
    ? client-port           =&gt; uint,
    ? message-data-index    =&gt; uint,
}
; Other map key values already defined above.
message-data-index = 3
</pre>
<h1 id="rfc.appendix.B"><a href="#rfc.appendix.B">Appendix B.</a> <a href="#dns-name-compression-example" id="dns-name-compression-example">DNS Name compression example</a></h1>
<p id="rfc.section.B.p.1">The basic algorithm, which follows the guidance in <a href="#RFC1035">[RFC1035]</a>, is simply to collect each name, and the offset in the packet at which it starts, during packet construction. As each name is added, it is offered to each of the collected names in order of collection, starting from the first name. If labels at the end of the name can be replaced with a reference back to part (or all) of the earlier name, and if the uncompressed part of the name is shorter than any compression already found, the earlier name is noted as the compression target for the name.  </p>
<p id="rfc.section.B.p.2">The following tables illustrate the process. In an example packet, the first name is example.com.  </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="right">N</th>
      <th class="left">Name</th>
      <th class="left">Uncompressed</th>
      <th class="left">Compression Target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="right">1</td>
      <td class="left">example.com</td>
      <td class="left"/>
      <td class="left"/>
    </tr>
  </tbody>
</table>
<p id="rfc.section.B.p.3">The next name added is bar.com. This is matched against example.com. The com part of this can be used as a compression target, with the remaining uncompressed part of the name being bar.  </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="right">N</th>
      <th class="left">Name</th>
      <th class="left">Uncompressed</th>
      <th class="left">Compression Target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="right">1</td>
      <td class="left">example.com</td>
      <td class="left"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="right">2</td>
      <td class="left">bar.com</td>
      <td class="left">bar</td>
      <td class="left">1 + offset to com</td>
    </tr>
  </tbody>
</table>
<p id="rfc.section.B.p.4">The third name added is www.bar.com. This is first matched against example.com, and as before this is recorded as a compression target, with the remaining uncompressed part of the name being www.bar. It is then matched against the second name, which again can be a compression target. Because the remaining uncompressed part of the name is www, this is an improved compression, and so it is adopted.  </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="right">N</th>
      <th class="left">Name</th>
      <th class="left">Uncompressed</th>
      <th class="left">Compression Target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="right">1</td>
      <td class="left">example.com</td>
      <td class="left"/>
      <td class="left"/>
    </tr>
    <tr>
      <td class="right">2</td>
      <td class="left">bar.com</td>
      <td class="left">bar</td>
      <td class="left">1 + offset to com</td>
    </tr>
    <tr>
      <td class="right">3</td>
      <td class="left">www.bar.com</td>
      <td class="left">www</td>
      <td class="left">2</td>
    </tr>
  </tbody>
</table>
<p id="rfc.section.B.p.5">As an optimization, if a name is already perfectly compressed (in other words, the uncompressed part of the name is empty), then no further names will be considered for compression.  </p>
<h1 id="rfc.appendix.B.1"><a href="#rfc.appendix.B.1">B.1.</a> <a href="#nsd-compression-algorithm" id="nsd-compression-algorithm">NSD compression algorithm</a></h1>
<p id="rfc.section.B.1.p.1">Using the above basic algorithm the packet lengths of responses generated by <a href="https://www.nlnetlabs.nl/projects/nsd/">NSD</a> can be matched almost exactly. At the time of writing, a tiny number (&lt;.01%) of the reconstructed packets had incorrect lengths.  </p>
<h1 id="rfc.appendix.B.2"><a href="#rfc.appendix.B.2">B.2.</a> <a href="#knot-authoritative-compression-algorithm" id="knot-authoritative-compression-algorithm">Knot Authoritative compression algorithm</a></h1>
<p id="rfc.section.B.2.p.1">The <a href="https://www.knot-dns.cz/">Knot Authoritative</a> name server uses different compression behavior, which is the result of internal optimization designed to balance runtime speed with compression size gains. In brief, and omitting complications, Knot  Authoritative will only consider the QNAME and names in the immediately preceding RR section in an RRSET as compression targets.  </p>
<p id="rfc.section.B.2.p.2">A set of smart heuristics as described below can be implemented to mimic this and while not perfect it produces output nearly, but not quite, as good a match as with NSD.  The heuristics are: </p>
<p/>

<ol>
  <li>A match is only perfect if the name is completely compressed AND the TYPE of the section in which the name occurs matches the TYPE of the name used as the compression target.</li>
  <li>If the name occurs in RDATA: <ul><li>If the compression target name is in a query, then only the first RR in an RRSET can use that name as a compression target.</li><li>The compression target name MUST be in RDATA.</li><li>The name section TYPE must match the compression target name section TYPE.</li><li>The compression target name MUST be in the immediately preceding RR in the RRSET.</li></ul></li>
</ol>

<p> </p>
<p id="rfc.section.B.2.p.4">Using this algorithm less than 0.1% of the reconstructed packets had incorrect lengths.  </p>
<h1 id="rfc.appendix.B.3"><a href="#rfc.appendix.B.3">B.3.</a> <a href="#observed-differences" id="observed-differences">Observed differences</a></h1>
<p id="rfc.section.B.3.p.1">In sample traffic collected on a root name server around 2-4% of responses generated by Knot had different packet lengths to those produced by NSD.  </p>
<h1 id="rfc.appendix.C"><a href="#rfc.appendix.C">Appendix C.</a> <a href="#comparison-of-binary-formats" id="comparison-of-binary-formats">Comparison of Binary Formats</a></h1>
<p id="rfc.section.C.p.1">Several binary serialisation formats were considered, and for completeness were also compared to JSON.  </p>
<p/>

<ul>
  <li><a href="https://avro.apache.org/">Apache Avro</a>. Data is stored according to a pre-defined schema. The schema itself is always included in the data file. Data can therefore be stored untagged, for a smaller serialisation size, and be written and read by an Avro library.  <ul><li>At the time of writing, Avro libraries are available for C, C++, C#, Java, Python, Ruby and PHP. Optionally tools are available for C++, Java and C# to generate code for encoding and decoding.</li></ul></li>
  <li><a href="https://developers.google.com/protocol-buffers/">Google Protocol Buffers</a>. Data is stored according to a pre-defined schema. The schema is used by a generator to generate code for encoding and decoding the data. Data can therefore be stored untagged, for a smaller serialisation size.  The schema is not stored with the data, so unlike Avro cannot be read with a generic library.  <ul><li>Code must be generated for a particular data schema to to read and write data using that schema. At the time of writing, the Google code generator can currently generate code for encoding and decoding a schema for C++, Go, Java, Python, Ruby, C#, Objective-C, Javascript and PHP.</li></ul></li>
  <li><a href="http://cbor.io">CBOR</a>. Defined in <a href="#RFC7049">[RFC7049]</a>, this serialisation format is comparable to JSON but with a binary representation. It does not use a pre-defined schema, so data is always stored tagged. However, CBOR data schemas can be described using CDDL <a href="#I-D.ietf-cbor-cddl">[I-D.ietf-cbor-cddl]</a> and tools exist to verify data files conform to the schema.  <ul><li>CBOR is a simple format, and simple to implement. At the time of writing, the CBOR website lists implementations for 16 languages.</li></ul></li>
</ul>

<p> </p>
<p id="rfc.section.C.p.3">Avro and Protocol Buffers both allow storage of untagged data, but because they rely on the data schema for this, their implementation is considerably more complex than CBOR. Using Avro or Protocol Buffers in an unsupported environment would require notably greater development effort compared to CBOR.  </p>
<p id="rfc.section.C.p.4">A test program was written which reads input from a PCAP file and writes output using one of two basic structures; either a simple structure, where each query/response pair is represented in a single record entry, or the C-DNS block structure.  </p>
<p id="rfc.section.C.p.5">The resulting output files were then compressed using a variety of common general-purpose lossless compression tools to explore the compressibility of the formats. The compression tools employed were: </p>
<p/>

<ul>
  <li><a href="https://github.com/kubo/snzip">snzip</a>. A command line compression tool based on the <a href="http://google.github.io/snappy/">Google Snappy</a> library.</li>
  <li><a href="http://lz4.github.io/lz4/">lz4</a>. The command line compression tool from the reference C LZ4 implementation.</li>
  <li><a href="http://www.gzip.org/">gzip</a>. The ubiquitous GNU zip tool.</li>
  <li><a href="http://facebook.github.io/zstd/">zstd</a>. Compression using the Zstandard algorithm.</li>
  <li><a href="http://tukaani.org/xz/">xz</a>. A popular compression tool noted for high compression.</li>
</ul>

<p> </p>
<p id="rfc.section.C.p.7">In all cases the compression tools were run using their default settings.  </p>
<p id="rfc.section.C.p.8">Note that this draft does not mandate the use of compression, nor any particular compression scheme, but it anticipates that in practice output data will be subject to general-purpose compression, and so this should be taken into consideration.  </p>
<p><samp>test.pcap</samp>, a 662Mb capture of sample data from a root instance was used for the comparison. The following table shows the formatted size and size after compression (abbreviated to Comp. in the table headers), together with the task resident set size (RSS) and the user time taken by the compression. File sizes are in Mb, RSS in kb and user time in seconds.  </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="left">Format</th>
      <th class="right">File size</th>
      <th class="left">Comp.</th>
      <th class="right">Comp. size</th>
      <th class="right">RSS</th>
      <th class="right">User time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">PCAP</td>
      <td class="right">661.87</td>
      <td class="left">snzip</td>
      <td class="right">212.48</td>
      <td class="right">2696</td>
      <td class="right">1.26</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">lz4</td>
      <td class="right">181.58</td>
      <td class="right">6336</td>
      <td class="right">1.35</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">gzip</td>
      <td class="right">153.46</td>
      <td class="right">1428</td>
      <td class="right">18.20</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">zstd</td>
      <td class="right">87.07</td>
      <td class="right">3544</td>
      <td class="right">4.27</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">xz</td>
      <td class="right">49.09</td>
      <td class="right">97416</td>
      <td class="right">160.79</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left"/>
      <td class="right"/>
      <td class="right"/>
      <td class="right"/>
    </tr>
    <tr>
      <td class="left">JSON simple</td>
      <td class="right">4113.92</td>
      <td class="left">snzip</td>
      <td class="right">603.78</td>
      <td class="right">2656</td>
      <td class="right">5.72</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">lz4</td>
      <td class="right">386.42</td>
      <td class="right">5636</td>
      <td class="right">5.25</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">gzip</td>
      <td class="right">271.11</td>
      <td class="right">1492</td>
      <td class="right">73.00</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">zstd</td>
      <td class="right">133.43</td>
      <td class="right">3284</td>
      <td class="right">8.68</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">xz</td>
      <td class="right">51.98</td>
      <td class="right">97412</td>
      <td class="right">600.74</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left"/>
      <td class="right"/>
      <td class="right"/>
      <td class="right"/>
    </tr>
    <tr>
      <td class="left">Avro simple</td>
      <td class="right">640.45</td>
      <td class="left">snzip</td>
      <td class="right">148.98</td>
      <td class="right">2656</td>
      <td class="right">0.90</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">lz4</td>
      <td class="right">111.92</td>
      <td class="right">5828</td>
      <td class="right">0.99</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">gzip</td>
      <td class="right">103.07</td>
      <td class="right">1540</td>
      <td class="right">11.52</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">zstd</td>
      <td class="right">49.08</td>
      <td class="right">3524</td>
      <td class="right">2.50</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">xz</td>
      <td class="right">22.87</td>
      <td class="right">97308</td>
      <td class="right">90.34</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left"/>
      <td class="right"/>
      <td class="right"/>
      <td class="right"/>
    </tr>
    <tr>
      <td class="left">CBOR simple</td>
      <td class="right">764.82</td>
      <td class="left">snzip</td>
      <td class="right">164.57</td>
      <td class="right">2664</td>
      <td class="right">1.11</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">lz4</td>
      <td class="right">120.98</td>
      <td class="right">5892</td>
      <td class="right">1.13</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">gzip</td>
      <td class="right">110.61</td>
      <td class="right">1428</td>
      <td class="right">12.88</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">zstd</td>
      <td class="right">54.14</td>
      <td class="right">3224</td>
      <td class="right">2.77</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">xz</td>
      <td class="right">23.43</td>
      <td class="right">97276</td>
      <td class="right">111.48</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left"/>
      <td class="right"/>
      <td class="right"/>
      <td class="right"/>
    </tr>
    <tr>
      <td class="left">PBuf simple</td>
      <td class="right">749.51</td>
      <td class="left">snzip</td>
      <td class="right">167.16</td>
      <td class="right">2660</td>
      <td class="right">1.08</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">lz4</td>
      <td class="right">123.09</td>
      <td class="right">5824</td>
      <td class="right">1.14</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">gzip</td>
      <td class="right">112.05</td>
      <td class="right">1424</td>
      <td class="right">12.75</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">zstd</td>
      <td class="right">53.39</td>
      <td class="right">3388</td>
      <td class="right">2.76</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">xz</td>
      <td class="right">23.99</td>
      <td class="right">97348</td>
      <td class="right">106.47</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left"/>
      <td class="right"/>
      <td class="right"/>
      <td class="right"/>
    </tr>
    <tr>
      <td class="left">JSON block</td>
      <td class="right">519.77</td>
      <td class="left">snzip</td>
      <td class="right">106.12</td>
      <td class="right">2812</td>
      <td class="right">0.93</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">lz4</td>
      <td class="right">104.34</td>
      <td class="right">6080</td>
      <td class="right">0.97</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">gzip</td>
      <td class="right">57.97</td>
      <td class="right">1604</td>
      <td class="right">12.70</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">zstd</td>
      <td class="right">61.51</td>
      <td class="right">3396</td>
      <td class="right">3.45</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">xz</td>
      <td class="right">27.67</td>
      <td class="right">97524</td>
      <td class="right">169.10</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left"/>
      <td class="right"/>
      <td class="right"/>
      <td class="right"/>
    </tr>
    <tr>
      <td class="left">Avro block</td>
      <td class="right">60.45</td>
      <td class="left">snzip</td>
      <td class="right">48.38</td>
      <td class="right">2688</td>
      <td class="right">0.20</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">lz4</td>
      <td class="right">48.78</td>
      <td class="right">8540</td>
      <td class="right">0.22</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">gzip</td>
      <td class="right">39.62</td>
      <td class="right">1576</td>
      <td class="right">2.92</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">zstd</td>
      <td class="right">29.63</td>
      <td class="right">3612</td>
      <td class="right">1.25</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">xz</td>
      <td class="right">18.28</td>
      <td class="right">97564</td>
      <td class="right">25.81</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left"/>
      <td class="right"/>
      <td class="right"/>
      <td class="right"/>
    </tr>
    <tr>
      <td class="left">CBOR block</td>
      <td class="right">75.25</td>
      <td class="left">snzip</td>
      <td class="right">53.27</td>
      <td class="right">2684</td>
      <td class="right">0.24</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">lz4</td>
      <td class="right">51.88</td>
      <td class="right">8008</td>
      <td class="right">0.28</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">gzip</td>
      <td class="right">41.17</td>
      <td class="right">1548</td>
      <td class="right">4.36</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">zstd</td>
      <td class="right">30.61</td>
      <td class="right">3476</td>
      <td class="right">1.48</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">xz</td>
      <td class="right">18.15</td>
      <td class="right">97556</td>
      <td class="right">38.78</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left"/>
      <td class="right"/>
      <td class="right"/>
      <td class="right"/>
    </tr>
    <tr>
      <td class="left">PBuf block</td>
      <td class="right">67.98</td>
      <td class="left">snzip</td>
      <td class="right">51.10</td>
      <td class="right">2636</td>
      <td class="right">0.24</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">lz4</td>
      <td class="right">52.39</td>
      <td class="right">8304</td>
      <td class="right">0.24</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">gzip</td>
      <td class="right">40.19</td>
      <td class="right">1520</td>
      <td class="right">3.63</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">zstd</td>
      <td class="right">31.61</td>
      <td class="right">3576</td>
      <td class="right">1.40</td>
    </tr>
    <tr>
      <td class="left"/>
      <td class="right"/>
      <td class="left">xz</td>
      <td class="right">17.94</td>
      <td class="right">97440</td>
      <td class="right">33.99</td>
    </tr>
  </tbody>
</table>
<p id="rfc.section.C.p.10">The above results are discussed in the following sections.  </p>
<h1 id="rfc.appendix.C.1"><a href="#rfc.appendix.C.1">C.1.</a> <a href="#comparison-with-full-pcap-files" id="comparison-with-full-pcap-files">Comparison with full PCAP files</a></h1>
<p id="rfc.section.C.1.p.1">An important first consideration is whether moving away from PCAP offers significant benefits.  </p>
<p id="rfc.section.C.1.p.2">The simple binary formats are typically larger than PCAP, even though they omit some information such as Ethernet MAC addresses. But not only do they require less CPU to compress than PCAP, the resulting compressed files are smaller than compressed PCAP.  </p>
<h1 id="rfc.appendix.C.2"><a href="#rfc.appendix.C.2">C.2.</a> <a href="#simple-versus-block-coding" id="simple-versus-block-coding">Simple versus block coding</a></h1>
<p id="rfc.section.C.2.p.1">The intention of the block coding is to perform data de-duplication on query/response records within the block. The simple and block formats above store exactly the same information for each query/response record. This information is parsed from the DNS traffic in the input PCAP file, and in all cases each field has an identifier and the field data is typed.  </p>
<p id="rfc.section.C.2.p.2">The data de-duplication on the block formats show an order of magnitude reduction in the size of the format file size against the simple formats. As would be expected, the compression tools are able to find and exploit a lot of this duplication, but as the de-duplication process uses knowledge of DNS traffic, it is able to retain a size advantage. This advantage reduces as stronger compression is applied, as again would be expected, but even with the strongest compression applied the block formatted data remains around 75% of the size of the simple format and its compression requires roughly a third of the CPU time.  </p>
<h1 id="rfc.appendix.C.3"><a href="#rfc.appendix.C.3">C.3.</a> <a href="#binary-versus-text-formats" id="binary-versus-text-formats">Binary versus text formats</a></h1>
<p id="rfc.section.C.3.p.1">Text data formats offer many advantages over binary formats, particularly in the areas of ad-hoc data inspection and extraction. It was therefore felt worthwhile to carry out a direct comparison, implementing JSON versions of the simple and block formats.  </p>
<p id="rfc.section.C.3.p.2">Concentrating on JSON block format, the format files produced are a significant fraction of an order of magnitude larger than binary formats. The impact on file size after compression is as might be expected from that starting point; the stronger compression produces files that are 150% of the size of similarly compressed binary format, and require over 4x more CPU to compress.  </p>
<h1 id="rfc.appendix.C.4"><a href="#rfc.appendix.C.4">C.4.</a> <a href="#performance" id="performance">Performance</a></h1>
<p id="rfc.section.C.4.p.1">Concentrating again on the block formats, all three produce format files that are close to an order of magnitude smaller that the original <samp>test.pcap</samp> file.  CBOR produces the largest files and Avro the smallest, 20% smaller than CBOR.  </p>
<p id="rfc.section.C.4.p.2">However, once compression is taken into account, the size difference narrows. At medium compression (with gzip), the size difference is 4%.  Using strong compression (with xz) the difference reduces to 2%, with Avro the largest and Protocol Buffers the smallest, although CBOR and Protocol Buffers require slightly more compression CPU.  </p>
<p id="rfc.section.C.4.p.3">The measurements presented above do not include data on the CPU required to generate the format files. Measurements indicate that writing Avro requires 10% more CPU than CBOR or Protocol Buffers.  It appears, therefore, that Avro's advantage in compression CPU usage is probably offset by a larger CPU requirement in writing Avro.  </p>
<h1 id="rfc.appendix.C.5"><a href="#rfc.appendix.C.5">C.5.</a> <a href="#conclusions" id="conclusions">Conclusions</a></h1>
<p id="rfc.section.C.5.p.1">The above assessments lead us to the choice of a binary format file using blocking.  </p>
<p id="rfc.section.C.5.p.2">As noted previously, this draft anticipates that output data will be subject to compression. There is no compelling case for one particular binary serialisation format in terms of either final file size or machine resources consumed, so the choice must be largely based on other factors. CBOR was therefore chosen as the binary serialisation format for the reasons listed in <a href="#choice-of-cbor">Section 5</a>.  </p>
<h1 id="rfc.appendix.C.6"><a href="#rfc.appendix.C.6">C.6.</a> <a href="#block-size-choice" id="block-size-choice">Block size choice</a></h1>
<p id="rfc.section.C.6.p.1">Given the choice of a CBOR format using blocking, the question arises of what an appropriate default value for the maximum number of query/response pairs in a block should be. This has two components; what is the impact on performance of using different block sizes in the format file, and what is the impact on the size of the format file before and after compression.  </p>
<p id="rfc.section.C.6.p.2">The following table addresses the performance question, showing the impact on the performance of a C++ program converting <samp>test.pcap</samp> to C-DNS. File size is in Mb, resident set size (RSS) in kb.  </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <thead>
    <tr>
      <th class="right">Block size</th>
      <th class="right">File size</th>
      <th class="right">RSS</th>
      <th class="right">User time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="right">1000</td>
      <td class="right">133.46</td>
      <td class="right">612.27</td>
      <td class="right">15.25</td>
    </tr>
    <tr>
      <td class="right">5000</td>
      <td class="right">89.85</td>
      <td class="right">676.82</td>
      <td class="right">14.99</td>
    </tr>
    <tr>
      <td class="right">10000</td>
      <td class="right">76.87</td>
      <td class="right">752.40</td>
      <td class="right">14.53</td>
    </tr>
    <tr>
      <td class="right">20000</td>
      <td class="right">67.86</td>
      <td class="right">750.75</td>
      <td class="right">14.49</td>
    </tr>
    <tr>
      <td class="right">40000</td>
      <td class="right">61.88</td>
      <td class="right">736.30</td>
      <td class="right">14.29</td>
    </tr>
    <tr>
      <td class="right">80000</td>
      <td class="right">58.08</td>
      <td class="right">694.16</td>
      <td class="right">14.28</td>
    </tr>
    <tr>
      <td class="right">160000</td>
      <td class="right">55.94</td>
      <td class="right">733.84</td>
      <td class="right">14.44</td>
    </tr>
    <tr>
      <td class="right">320000</td>
      <td class="right">54.41</td>
      <td class="right">799.20</td>
      <td class="right">13.97</td>
    </tr>
  </tbody>
</table>
<p id="rfc.section.C.6.p.3">Increasing block size, therefore, tends to increase maximum RSS a little, with no significant effect (if anything a small reduction) on CPU consumption.  </p>
<p id="rfc.section.C.6.p.4">The following figure plots the effect of increasing block size on output file size for different compressions.  </p>
<p><a href="https://github.com/dns-stats/draft-dns-capture-format/blob/master/file-size-versus-block-size.png">Figure showing effect of block size on file size (PNG)</a> </p>
<p><a href="https://github.com/dns-stats/draft-dns-capture-format/blob/master/file-size-versus-block-size.svg">Figure showing effect of block size on file size (SVG)</a> </p>
<p id="rfc.section.C.6.p.7">From the above, there is obviously scope for tuning the default block size to the compression being employed, traffic characteristics, frequency of output file rollover etc. Using a strong compression, block sizes over 10,000 query/response pairs would seem to offer limited improvements.  </p>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Authors' Addresses</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">John Dickinson</span> 
	  <span class="n hidden">
		<span class="family-name">Dickinson</span>
	  </span>
	</span>
	<span class="org vcardline">Sinodun IT</span>
	<span class="adr">
	  <span class="vcardline">Magdalen Centre</span>
<span class="vcardline">Oxford Science Park</span>

	  <span class="vcardline">
		<span class="locality">Oxford</span>,  
		<span class="region"></span>
		<span class="code">OX4 4GA</span>
	  </span>
	  <span class="country-name vcardline">United Kingdom</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:jad@sinodun.com">jad@sinodun.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Jim Hague</span> 
	  <span class="n hidden">
		<span class="family-name">Hague</span>
	  </span>
	</span>
	<span class="org vcardline">Sinodun IT</span>
	<span class="adr">
	  <span class="vcardline">Magdalen Centre</span>
<span class="vcardline">Oxford Science Park</span>

	  <span class="vcardline">
		<span class="locality">Oxford</span>,  
		<span class="region"></span>
		<span class="code">OX4 4GA</span>
	  </span>
	  <span class="country-name vcardline">United Kingdom</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:jim@sinodun.com">jim@sinodun.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Sara Dickinson</span> 
	  <span class="n hidden">
		<span class="family-name">Dickinson</span>
	  </span>
	</span>
	<span class="org vcardline">Sinodun IT</span>
	<span class="adr">
	  <span class="vcardline">Magdalen Centre</span>
<span class="vcardline">Oxford Science Park</span>

	  <span class="vcardline">
		<span class="locality">Oxford</span>,  
		<span class="region"></span>
		<span class="code">OX4 4GA</span>
	  </span>
	  <span class="country-name vcardline">United Kingdom</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:sara@sinodun.com">sara@sinodun.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Terry Manderson</span> 
	  <span class="n hidden">
		<span class="family-name">Manderson</span>
	  </span>
	</span>
	<span class="org vcardline">ICANN</span>
	<span class="adr">
	  <span class="vcardline">12025 Waterfront Drive</span>
<span class="vcardline">Suite 300</span>

	  <span class="vcardline">
		<span class="locality">Los Angeles</span>,  
		<span class="region"></span>
		<span class="code">CA 90094-2536</span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:terry.manderson@icann.org">terry.manderson@icann.org</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">John Bond</span> 
	  <span class="n hidden">
		<span class="family-name">Bond</span>
	  </span>
	</span>
	<span class="org vcardline">ICANN</span>
	<span class="adr">
	  <span class="vcardline">12025 Waterfront Drive</span>
<span class="vcardline">Suite 300</span>

	  <span class="vcardline">
		<span class="locality">Los Angeles</span>,  
		<span class="region"></span>
		<span class="code">CA 90094-2536</span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:john.bond@icann.org">john.bond@icann.org</a></span>

  </address>
</div>

</body>
</html>
